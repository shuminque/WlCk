<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>首页</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/static/lib/layui-v2.6.3/css/layui.css" media="all">
    <link rel="stylesheet" href="/static/lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all">
    <link rel="stylesheet" href="/static/css/public.css" media="all">
    <!--[if lt IE 9]>
    <script src="/static/js/otherJs/cdn.staticfile.org_html5shiv_r29_html5.min.js"></script>
    <script src="/static/js/otherJs/cdn.staticfile.org_respond.js_1.4.2_respond.min.js"></script>
    <![endif]-->
    <style>
        .layui-card {border:1px solid #f2f2f2;border-radius:5px;}
        .icon {margin-right:10px;color:#1aa094;}
        .icon-cray {color:#ffb800!important;}
        .icon-blue {color:#1e9fff!important;}
        .icon-tip {color:#ff5722!important;}
        .layuimini-qiuck-module {text-align:center;margin-top: 10px}
        .layuimini-qiuck-module a i {display:inline-block;width:100%;height:60px;line-height:60px;text-align:center;border-radius:2px;font-size:30px;background-color:#F8F8F8;color:#333;transition:all .3s;-webkit-transition:all .3s;}
        .layuimini-qiuck-module a cite {position:relative;top:2px;display:block;color:#666;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;font-size:14px;}
        .welcome-module {width:100%;height:210px;}
        .panel {background-color:#fff;border:1px solid transparent;border-radius:3px;-webkit-box-shadow:0 1px 1px rgba(0,0,0,.05);box-shadow:0 1px 1px rgba(0,0,0,.05)}
        .panel-body {padding:10px}
        .panel-title {margin-top:0;margin-bottom:0;font-size:12px;color:inherit}
        .label {display:inline;padding:.2em .6em .3em;font-size:75%;font-weight:700;line-height:1;color:#fff;text-align:center;white-space:nowrap;vertical-align:baseline;border-radius:.25em;margin-top: .3em;}
        .layui-red {color:red}
        .main_btn > p {height:40px;}
        .layui-bg-number {background-color:#F8F8F8;}
        .layuimini-notice-container {
            max-height: 200px; /* 设置一个最大高度 */
            overflow-y: auto; /* 添加垂直滚动条 */
        }
        /* 保持其他样式不变 */
        .layuimini-notice:hover {background:#f6f6f6;}
        .layuimini-notice {padding:7px 16px;clear:both;font-size:12px !important;cursor:pointer;position:relative;transition:background 0.2s ease-in-out;}
        .layuimini-notice-title,.layuimini-notice-label {
            padding-right: 70px !important;text-overflow:ellipsis!important;overflow:hidden!important;white-space:nowrap!important;}
        .layuimini-notice-title {line-height:28px;font-size:14px;}
        .layuimini-notice-extra {position:absolute;top:50%;margin-top:-8px;right:16px;display:inline-block;height:16px;color:#999;}
        .layui-table-view .layui-table-body tr.layui-table-hover {
            background-color: #f2f2f2; /* 高亮行的背景色，可根据需要调整 */
        }

        .layui-table-view .layui-table-body tr td {
            padding: 2px 8px; /* 减少行内间距 */
            line-height: 1.2; /* 调整行高 */
        }

        .layui-table-view .layui-table-header tr th {
            padding: 2px 8px; /* 减少标题行内间距 */
            line-height: 1.2; /* 调整标题行高 */
        }
        .custom-input {
            text-align: left;  /* 使内容左对齐 */
        }


    </style>
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">
        <div class="layui-row layui-col-space8">
            <div class="layui-col-md4">
                <div class="layui-row layui-col-space10">
                    <div class="layui-col-md15">
                        <div class="layui-card">
                            <div class="layui-card-header"><i class="fa fa-signal icon"></i>数据统计（不包含呆滞仓数据）</div>
                            <div class="layui-card-body">
                                <div class="welcome-module">
                                    <div class="layui-row layui-col-space10">
                                        <div class="layui-col-xs6">
                                            <div class="panel layui-bg-number">
                                                <div class="panel-body">
                                                    <div class="panel-title">
                                                        <span class="label pull-right layui-bg-blue">A</span>
                                                        <h5>SAB在库金额</h5>
                                                    </div>
                                                    <div class="panel-content">
                                                        <h1 th:text="${SABpriceSum}"></h1>
                                                        <small>SAB在库金额  CNY</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-col-xs6">
                                            <div class="panel layui-bg-number">
                                                <div class="panel-body">
                                                    <div class="panel-title">
                                                        <span class="label pull-right layui-bg-cyan">B</span>
                                                        <h5>ZAB在库金额</h5>
                                                    </div>
                                                    <div class="panel-content">
                                                        <h1 th:text="${ZABpriceSum}"></h1>
                                                        <small>ZAB在库金额  CNY</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-col-xs6">
                                            <div class="panel layui-bg-number">
                                                <div class="panel-body">
                                                    <div class="panel-title">
                                                        <span class="label pull-right layui-bg-orange">C</span>
                                                        <h5>SAB在库数</h5>
                                                    </div>
                                                    <div class="panel-content">
                                                        <h1 th:text="${SABcountSum}"></h1>
                                                        <small>SAB在库数</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-col-xs6">
                                            <div class="panel layui-bg-number">
                                                <div class="panel-body">
                                                    <div class="panel-title">
                                                        <span class="label pull-right layui-bg-green">D</span>
                                                        <h5>ZAB在库数</h5>
                                                    </div>
                                                    <div class="panel-content">
                                                        <h1 th:text="${ZABcountSum}"></h1>
                                                        <small>ZAB在库数</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="layui-col-md4" style="display: none;">
                        <div class="layui-card">
                            <div class="layui-card-he   ader"><i class="fa fa-credit-card icon icon-blue"></i>快捷入口</div>
                            <div class="layui-card-body">
                                <div class="welcome-module">
                                    <div class="layui-row layui-col-space10 layuimini-qiuck">
                                        <!-- 入库申请 -->
                                        <div class="layui-col-xs3 layuimini-qiuck-module">
                                            <a href="javascript:;" layuimini-content-href="/application_in" data-title="入库申请" data-icon="fa fa-arrow-down">
                                                <i class="fa fa-arrow-down"></i>
                                                <cite>入库申请</cite>
                                            </a>
                                        </div>
                                        <!-- 出库申请 -->
                                        <div class="layui-col-xs3 layuimini-qiuck-module">
                                            <a href="javascript:;" layuimini-content-href="/application_out" data-title="出库申请" data-icon="fa fa-arrow-up">
                                                <i class="fa fa-arrow-up"></i>
                                                <cite>出库申请</cite>
                                            </a>
                                        </div>
                                        <!-- 转移申请 -->
                                        <div class="layui-col-xs3 layuimini-qiuck-module">
                                            <a href="javascript:;" layuimini-content-href="/application_transfer" data-title="转移申请" data-icon="fa fa-exchange">
                                                <i class="fa fa-exchange"></i>
                                                <cite>转移申请</cite>
                                            </a>
                                        </div>
                                        <!-- 一次性填写 -->
                                        <div class="layui-col-xs3 layuimini-qiuck-module">
                                            <a href="javascript:;" layuimini-content-href="/once_add" data-title="一次性填写" data-icon="fa fa-pencil-alt">
                                                <i class="fa fa-pencil"></i>
                                                <cite>一次性填写</cite>
                                            </a>
                                        </div>
                                        <!-- 入库查询 -->
                                        <div class="layui-col-xs3 layuimini-qiuck-module">
                                            <a href="javascript:;" layuimini-content-href="/table_in" data-title="入库查询" data-icon="fa fa-search">
                                                <i class="fa fa-search-plus"></i>
                                                <cite>入库查询</cite>
                                            </a>
                                        </div>
                                        <!-- 出库查询 -->
                                        <div class="layui-col-xs3 layuimini-qiuck-module">
                                            <a href="javascript:;" layuimini-content-href="/table_out" data-title="出库查询" data-icon="fa fa-search">
                                                <i class="fa fa-search-minus"></i>
                                                <cite>出库查询</cite>
                                            </a>
                                        </div>
                                        <!-- 库存查询 -->
                                        <div class="layui-col-xs3 layuimini-qiuck-module">
                                            <a href="javascript:;" layuimini-content-href="/table_stock" data-title="库存查询" data-icon="fa fa-search">
                                                <i class="fa fa-list-alt"></i>
                                                <cite>库存查询</cite>
                                            </a>
                                        </div>
                                        <!-- 一次性报表 -->
                                        <div class="layui-col-xs3 layuimini-qiuck-module">
                                            <a href="javascript:;" layuimini-content-href="/once_table" data-title="一次性报表" data-icon="fa fa-pie-chart">
                                                <i class="fa fa-pie-chart"></i>
                                                <cite>一次性报表</cite>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 公告数据表格容器 -->
            <div class="layui-col-md8">
                <div class="layui-card">
                    <div class="layui-card-header"><i class="fa fa-bullhorn icon icon-tip"></i>安全库存警报(在库为0)</div>
                    <div class="layui-card-body">
                        <table id="noticeTable" lay-filter="noticeTable"></table>
                    </div>
                </div>
            </div>
        </div>
        <input class="layui-input" type="text" id="year-selector0" placeholder="请选择查看的年份" autocomplete="off">
        <!-- 库存数据分析表格 -->
        <div class="layui-row" style="display: none">
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-header"><i class="fa fa-table icon"></i>库存数据分析表</div>
                    <div class="layui-card-body">
                        <table class="layui-table" id="inventory-table" lay-filter="inventoryTable"></table>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-row">
            <!-- 月度库存分析柱形图 -->
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-header"><i class="fa fa-bar-chart icon"></i>月度库存分析柱形图</div>
                    <div class="layui-card-body">
                        <div id="inventory-bar-chart" style="width: 100%; height: 500px;"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-row">
            <!-- 库存周转率分析柱形图 -->
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-header"><i class="fa fa-bar-chart icon"></i>库存周转率分析柱形图</div>
                    <div class="layui-card-body">
                        <div id="turnover-bar-chart" style="width: 100%; height: 500px;"></div>
                    </div>
                </div>
            </div>
        </div>
<!--        <div class="layui-row">-->
<!--            &lt;!&ndash; 入库金额折线图 &ndash;&gt;-->
<!--            <div class="layui-col-md6">-->
<!--                <div class="layui-card">-->
<!--                    <div class="layui-card-header"><i class="fa fa-signal icon"></i>入库折线图</div>-->
<!--                    <div class="layui-card-body">-->
<!--                        <div id="inbound-chart" style="width: 100%; height: 500px;"></div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--            &lt;!&ndash; 出库金额折线图 &ndash;&gt;-->
<!--            <div class="layui-col-md6">-->
<!--                <div class="layui-card">-->
<!--                    <div class="layui-card-header"><i class="fa fa-signal icon"></i>出库折线图</div>-->
<!--                    <div class="layui-card-body">-->
<!--                        <div id="outbound-chart" style="width: 100%; height: 500px;"></div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->

<!--        <div class="layui-row">-->
<!--            &lt;!&ndash; 在库金额柱形图 &ndash;&gt;-->
<!--            <div class="layui-col-md12">-->
<!--                <div class="layui-card">-->
<!--                    <div class="layui-card-header"><i class="fa fa-signal icon"></i>在库金额柱形图</div>-->
<!--                    <div class="layui-card-body">-->
<!--                        <div id="stock-chart" style="width: 100%; height: 500px;"></div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->

        <div>
            <select id="depository-selector-three">
                <option value="">选择厂区</option>
                <option value="1">SAB</option>
                <option value="2" selected>ZAB</option>
            </select>
            <input type="text" id="year-selector-three" placeholder="请选择年" autocomplete="off">
            <button id="clear-category-btn" type="button">清空分类</button>
            <button class="layui-input custom-input" id="ID-dropdown-demo-complex-1" >请选择分类</button>
            <input type="hidden" name="applyRemark" id="applyRemarkInput-1" value="">
            <div class="layui-row">
                <!-- 产量柱形图 -->
                <div class="layui-col-md12">
                    <div class="layui-card">
                            <div class="layui-card-header"><i class="fa fa-signal icon"></i>月别成本分析图</div>
                        <div class="layui-card-body">
                            <div id="cateAmountChart" style="width: 100%; height: 500px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="recordTableContainer2" style="display: none">
                <table class="layui-hide" id="recordTable2" lay-filter="recordTableFilter2"></table>
            </div>
        </div>

        <div>
            <select id="depository-selector">
                <option value="">选择厂区</option>
                <option value="1">SAB</option>
                <option value="2" selected>ZAB</option>
            </select>
            <input type="text" id="month-selector" placeholder="请选择年月" autocomplete="off">
            <div class="layui-row">
                <!-- 各工程使用金额分析图 -->
                <div class="layui-col-md12">
                    <div class="layui-card">
                        <div class="layui-card-header"><i class="fa fa-signal icon"></i>各工程使用成本分析图</div>

                        <div class="layui-card-body" style="display: flex; align-items: flex-start;">
                            <div id="other-category-bar-chart" style="width: 35%; height: 800px; margin-left: 15px;"></div>
                            <!-- 右侧的纵向柱形图 -->
                            <div id="category-bar-chart" style="width: 100%; height: 800px;margin-top: 0px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 新增的各型号分析图 -->
            <div class="layui-row">
                <div class="layui-col-md12">
                    <div class="layui-card">
                        <div class="layui-card-header"><i class="fa fa-bar-chart icon"></i>各型号成本分布</div>
                        <div class="layui-card-body">
                            <div id="model-analysis-chart" style="width: 100%; height: 600px;"></div>
                        </div>
                        <div class="layui-card-body">
                            <div id="model-analysisTwo-chart" style="width: 100%; height: 600px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="recordTableContainer" style="display: none">
                <table class="layui-hide" id="recordTable" lay-filter="recordTableFilter"></table>
            </div>
        </div>


<!--        <div>-->
<!--            <select id="depository-selector-two">-->
<!--                <option value="">选择厂区</option>-->
<!--                <option value="1">SAB</option>-->
<!--                <option value="2">ZAB</option>-->
<!--            </select>-->
<!--            <input type="text" id="year-selector" placeholder="请选择年" autocomplete="off">-->
<!--            <select name="typeId" id="typeSelect">-->
<!--                <option value="">请选择分类</option>-->
<!--                <option th:each="type : ${materialTypes}" th:value="${type.id}" th:text="${type.id}+' '+${type.tname}"></option>-->
<!--            </select>-->
<!--            <div class="layui-row">-->
<!--                &lt;!&ndash; 产量柱形图 &ndash;&gt;-->
<!--                <div class="layui-col-md12">-->
<!--                    <div class="layui-card">-->
<!--                        <div class="layui-card-header"><i class="fa fa-signal icon"></i>产量柱形图</div>-->
<!--                        <div class="layui-card-body">-->
<!--                            <div id="typeAmountChart" style="width: 100%; height: 500px;"></div>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->

    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="/static/lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
<script src="/static/js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<script type="text/javascript" src="/static/js/http_ajax.googleapis.com_ajax_libs_jquery_3.5.1_jquery.js" charset="utf-8"></script>
<script type="text/javascript" src="/static/js/http_cdn.bootcdn.net_ajax_libs_echarts_5.2.0_echarts.js" charset="utf-8"></script>
<script>
    let dropDataSAB = [];
    let dropDataZAB = [];
    layui.use(['layer', 'miniTab','echarts','laydate','table'], function () {
        var $ = layui.jquery,
            layer = layui.layer,
            miniTab = layui.miniTab,
            echarts = layui.echarts,
            laydate = layui.laydate,
            table = layui.table;
        var dropdown = layui.dropdown;
        var userReviewGroupId;
        var userAuthority;
        var userDepositoryId;
        // 用户区分
        $.ajax({
            url: '/get_user_depository',
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                let pp;
                userDepositoryId = data.depositoryId;
                var toolbarTemplate;
                var globalToolbarTemplate;
                userAuthority = data.authority;
                userReviewGroupId = data.review_group_id;
                if (userDepositoryId === 0) {
                    pp = '/notices';
                } else {
                    pp = '/notices?depositoryId=' + userDepositoryId;
                }
                table.render({
                    elem: '#noticeTable',
                    url: pp, // 数据接口
                    height: "full-50",
                    height: 200,
                    parseData: function (res) { // res 即为原始返回的数据
                        return {
                            "status": res.status, // 解析接口状态
                            "message": res.statusInfo.message, // 解析提示文本
                            "count": res.count, // 解析数据长度
                            "data": res.data // 解析数据列表
                        };
                    },

                    response: {
                        statusName: 'status', // 规定数据状态的字段名称，默认：code
                        statusCode: 200, // 规定成功的状态码，默认：0
                        msgName: 'message', // 规定状态信息的字段名称，默认：msg
                        countName: 'count', // 规定数据总数的字段名称，默认：count
                        dataName: 'data' // 规定数据列表的字段名称，默认：data
                    },
                    cols: [ [ // 表头
                        {field: 'title', title: '标题', hide: true},

                        {field: 'atId', title: 'AT号', width:'10%'},
                        {field: 'mname', title: '品名', width:'30%'},
                        {field: 'model', title: '型号', width:'20%'},
                        {field: 'lastCount', title: '最后领用数', width:'12%'},
                        {field: 'time', title: '最后领用时间', width:'18%', sort: true, templet: function(d){
                                return formatDate(d.time);
                            }},
                    ]],
                    done: function(res, curr, count){
                        $('#noticeTable + div .layui-table-body tbody > tr').each(function(){
                            var dataIndex = $(this).attr('data-index');
                            var row = res.data[dataIndex];
                            $(this).css('background-color', 'yellow');
                        });
                    }
                });

                function formatDate(dateStr) {
                    if (!dateStr) return '';
                    let date = new Date(dateStr);
                    let year = date.getFullYear();
                    let month = (date.getMonth() + 1).toString().padStart(2, '0');
                    let day = date.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            },
            error: function() {
                layer.msg('无法获取用户的厂区信息');
            }
        });

        function formatData(apiData) {
            let formattedData = apiData.map(item => {
                let formattedItem = { title: item.title };
                if (item.children && item.children.length > 0) {
                    formattedItem.child = formatData(item.children); // 递归处理子项目
                }
                return formattedItem;
            });
            return formattedData;
        }

        function loadCategoryData(category, callback) {
            $.get('/api/categories/' + category, function(response) {
                console.log("数据内容",response.data);
                if (response.code === 0) {
                    const filteredData = response.data.filter(item => item.title !== "销售出库");
                    callback(formatData(filteredData));
                } else {
                    layer.msg(`无法加载${category.toUpperCase()}的分类数据`);
                }
            }).fail(function() {
                layer.msg(`无法加载${category.toUpperCase()}的分类数据`);
            });
        }

        function loadDepositoryDataForElem(elemSelector, dropdownData) {
            setParentForChild(dropdownData);
            dropdown.render({
                elem: elemSelector,
                data: dropdownData,
                click: function (item) {
                    let path = item.title;
                    let currentItem = item;
                    while (currentItem.parent) {
                        path = currentItem.parent.title + "-" + path;
                        currentItem = currentItem.parent;
                    }
                    let displayTitle = path.split('-').pop();
                    $(elemSelector).text(displayTitle);
                    const remarkInputSelector = elemSelector.replace(/ID-dropdown-demo-complex(-\d+)?$/, "applyRemarkInput$1");
                    $(remarkInputSelector).val(displayTitle);
                    fetchCateChart();
                }
            });
        }

        function setParentForChild(data) {
            for (let i = 0; i < data.length; i++) {
                if (data[i].child) {
                    for (let j = 0; j < data[i].child.length; j++) {
                        data[i].child[j].parent = data[i];
                    }
                    setParentForChild(data[i].child);
                }
            }
        }

        // 初始化日期选择器
        laydate.render({
            elem: '#month-selector',
            type: 'month',
            range: true,
            done: function(value, date, endDate) {
                if (document.getElementById('depository-selector').value) {
                    fetchDataForMonth(value);
                } else {
                    alert("请先选择一个厂区！");
                }
            }
        });

        laydate.render({ elem: '#year-selector', type: 'year' });
        laydate.render({ elem: '#year-selector-three', type: 'year', done: fetchCateChart });
        document.getElementById('clear-category-btn').addEventListener('click', function() {
            document.getElementById('applyRemarkInput-1').value = ''; // 清空分类输入框
            document.getElementById('ID-dropdown-demo-complex-1').textContent = '请选择分类'; // 重置按钮文本
            fetchCateChart(); // 调用 fetchCateChart 函数
        });

        var myChartCate = echarts.init(document.getElementById('cateAmountChart'));
        async function fetchCateChart() {
            var year = document.getElementById('year-selector-three').value;
            var depositoryId = document.getElementById('depository-selector-three').value;
            var categoryTitle = encodeURIComponent(document.getElementById('applyRemarkInput-1').value);

            if (!depositoryId) {
                alert("请确保已选择所有条件！");
                return;
            }
            var amountUrl = '/CategoryForYear/' + year + '/' + depositoryId;
            var lineData = []; // 默认设置为空数组
            var isLineDataEmpty = true; // 判断是否有产量数据

            // 如果 categoryTitle 不为空，则增加到 URL 中
            if (categoryTitle) {
                categoryTitle = encodeURIComponent(categoryTitle);
                amountUrl += '/' + categoryTitle;
            }

            // 构建 lineNameUrl
            var lineNameUrl = '/lineData/data/' + year;
            if (categoryTitle) {
                lineNameUrl += '/' + categoryTitle;
            }

            try {
                // 获取产量数据
                const lineDataResponse = await $.get(lineNameUrl);
                lineData = lineDataResponse.data;
                console.log(lineNameUrl);
                console.log(lineData);
                if (Array.isArray(lineData) && lineData.length > 0) {
                    isLineDataEmpty = false;
                }  else {
                    console.warn("No valid data received, resetting lineData to empty.");
                    lineData = [];
                    isLineDataEmpty = true;
                }
            } catch (error) {
                console.error("Error fetching line data:", error);
                lineData = []; // 确保发生错误时不会使用旧数据
                isLineDataEmpty = true;
            }
            console.log(isLineDataEmpty);
            if (isLineDataEmpty) {
                console.warn("当前分类无产量数据，将产量设置为全为零");
                lineData = []; // 清空 lineData，确保不会使用之前的数据
            }
            try {
                // 获取金额数据
                const amountData = await $.get(amountUrl);
                // 获取前一年金额数据的URL
                let prevYearAmountUrl = '/CategoryForYear/' + (year - 1) + '/' + depositoryId;
                if (categoryTitle) {
                    prevYearAmountUrl += '/' + categoryTitle;
                }
                // 获取前一年金额数据
                const prevYearData = await $.get(prevYearAmountUrl);
                // 获取前一年产量数据的URL
                let prevYearLineNameUrl = '/lineData/data/' + (year - 1);
                if (categoryTitle) {
                    prevYearLineNameUrl += '/' + categoryTitle;
                }
                // 获取前一年产量数据
                const prevYearLineData = await $.get(prevYearLineNameUrl);
                // 筛选出有数据的月份的产量
                // 确保先获取到数据数组
                const validProductionData = prevYearLineData.data.filter(item => item.production != null && item.production > 0);
                // 获取有效的月份（即有产量的月份）
                const validMonths = validProductionData.map(item => {
                    const month = new Date(item.date).toISOString().slice(0, 7); // 获取 "YYYY-MM" 格式的月份
                    return month;
                });
                // 筛选出有效的金额数据（根据有产量的月份进行过滤）
                const validAmountData = prevYearData.filter(item => {
                    const month = item.month;
                    return validMonths.includes(month);  // 只保留有对应产量数据的月份
                });
                const prevYearTotalAmount = validAmountData.reduce((sum, item) => sum + item.amount, 0);
                // 计算有数据的月份个数
                const validAmountMonthsCount = validAmountData.length;
                // 计算前一年的金额平均值
                const prevYearAverageAmount = validAmountMonthsCount > 0
                    ? (prevYearTotalAmount / validAmountMonthsCount).toFixed(0)  // 保留整数
                    : 0;
                console.log("前一年的金额平均值：", prevYearAverageAmount);
                // 计算前一年产量总和
                const prevYearTotalProduction = validProductionData.reduce((sum, item) => sum + item.production, 0)
                // 计算有数据的月份个数
                const validMonthsCount = validProductionData.length;
                // 计算前一年的产量平均值
                const prevYearAverageProduction = validMonthsCount > 0
                    ? (prevYearTotalProduction / validMonthsCount).toFixed(0)  // 保留整数
                    : 0;
                console.log("前一年的产量平均值：", prevYearAverageProduction);
                const prevYearcostPerUnit = prevYearAverageProduction > 0
                    ? (prevYearAverageAmount / prevYearAverageProduction).toFixed(4)  // 保留整数
                    : 0;
                console.log("前一年的产量单个成本：", prevYearcostPerUnit);

                // 计算每个月的单个成本
                const costPerUnit = amountData.map(function(item) {
                    var productionData = lineData.find(lineItem => {
                        const date = new Date(lineItem.date);
                        const month = date.getMonth() + 1;
                        const monthString = month < 10 ? '0' + month : month;
                        const normalizedMonth = `${date.getFullYear()}-${monthString}`;
                        return normalizedMonth === item.month;
                    });
                    return productionData && productionData.production > 0
                        ? (item.amount / productionData.production).toFixed(4)
                        : 0;
                });
// 计算非零单个成本的总和和数量
                const totalCost = costPerUnit.reduce((sum, cost) => {
                    return cost > 0 ? sum + parseFloat(cost) : sum;
                }, 0);

                const countNonZero = costPerUnit.filter(cost => cost > 0).length;

// 计算参考线值（平均单个成本），并保留4位小数
                const referenceLineValue = countNonZero > 0 ? (totalCost / countNonZero).toFixed(4) : 0; // 防止除零错误，并保留4位小数

                // 提取产量数据
                const productionData = amountData.map(function(item) {
                    var productionItem = lineData.find(lineItem => {
                        const date = new Date(lineItem.date);
                        const month = date.getMonth() + 1;
                        const monthString = month < 10 ? '0' + month : month;
                        const normalizedMonth = `${date.getFullYear()}-${monthString}`;
                        return normalizedMonth === item.month;
                    });
                    return productionItem ? productionItem.production : 0;
                });

                var colors = ['#5470C6', '#bf2222']; // 定义柱形图和折线图的颜色
                var option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'shadow' }
                    },
                    legend: {
                        data: ['金额', '单个成本'],
                        left: 'right',
                        selected: {
                            '金额': true,
                            '单个成本': !isLineDataEmpty, // 如果 lineData 为空，则默认取消选择单个成本
                        }
                    },
                    xAxis: {
                        data: [year-1+"年平均"]
                            .concat(amountData.map(function(item) { return item.month; })) // 合并当前年12个月的月份数据
                    },
                    yAxis: [
                        { type: 'value', name: '金额', position: 'left' },
                        { type: 'value', name: '单个成本', position: 'right', splitLine: { show: false } },
                        { type: 'value', name: '', position: 'right', axisLabel: { show: false }, splitLine: { show: false } }
                    ],
                    series: [
                        {
                            name: '单个成本',
                            type: 'line',
                            yAxisIndex: 1,
                            data: [prevYearcostPerUnit].concat(costPerUnit),
                            label: {
                                normal: {
                                    show: true,
                                    position: 'top',
                                    formatter: function(params) {
                                        // 获取当前标签的坐标
                                        const currentIndex = params.dataIndex;
                                        const prevIndex = currentIndex - 1;

                                        // 检查前后标签是否重叠，若重叠，则调整
                                        if (currentIndex > 0 && Math.abs(params.data - costPerUnit[prevIndex]) < 10) {
                                            return '{a| ' + params.value + '}';
                                        }
                                        return params.value;
                                    },
                                    rich: {
                                        a: {
                                            align: 'center',
                                            padding: [15, 0, 15, 0] // 可以根据需要调整位置
                                        }
                                    }
                                }
                            },
                            itemStyle: { normal: { color: colors[1] } },
                            lineStyle: { color: colors[1] },
                            markLine: {
                                data: [
                                    {
                                        name: '平均',
                                        yAxis: referenceLineValue,
                                        yAxisIndex: 1,
                                        label: {
                                            show: true,
                                            formatter: '{c}',
                                            position: 'end',
                                            rich: {
                                                a: {
                                                    align: 'center' ,
                                                    padding: [40, 10, 0, -45] // 左侧内边距负值，使其左移
                                                }
                                            },
                                            formatter: (params) => `{a|${params.value}}`
                                        },
                                        lineStyle: {
                                            type: 'solid',
                                            color: '#ffcf00'
                                        },
                                        xAxis: 'max'
                                    }
                                ]
                            }
                        },
                        {
                            name: '金额',
                            type: 'bar',
                            yAxisIndex: 0,
                            data: [prevYearAverageAmount].concat(amountData.map(function(item) { return item.amount; })),
                            label: {
                                normal: {
                                    show: true,
                                    position: 'inside',
                                    formatter: function(params) {
                                        const currentIndex = params.dataIndex +1;
                                        console.log(currentIndex);
                                        const prevIndex = currentIndex - 1;
                                        console.log(prevIndex);
                                        // 检查前后标签是否重叠，若重叠，则调整
                                        if (currentIndex < 0 && Math.abs(params.data - amountData[prevIndex].amount) < 10) {
                                            return '{a| ' + params.value + '}';

                                        }
                                        return params.value;
                                    },
                                    rich: {
                                        a: {
                                            align: 'center',
                                            padding: [-15, 0, 5, 0],
                                            color: '#ffffff'
                                        }
                                    },
                                }
                            },
                            itemStyle: { normal: { color: colors[0] } }, // 保持柱形颜色为蓝色
                            barWidth: '50%' // 设置柱宽为原本宽度的一半
                        },
                        {
                            name: '产量',
                            type: 'line', // 改成折线
                            yAxisIndex: 2, // 依然绑定到第3个Y轴
                            data: [prevYearAverageProduction].concat(productionData), // 数据仍然传入
                            lineStyle: { opacity: 0 }, // 隐藏线条
                            symbol: 'none', // 不显示拐点
                        }
                        // {
                        //     name: '产量',
                        //     type: 'bar',
                        //     yAxisIndex: 2,
                        //     data: productionData,
                        //     barWidth: 0, // 将 barWidth 设置为 0
                        //     label: { show: false },
                        //     itemStyle: { opacity: 0 }
                        // }
                    ]
                };
                myChartCate.clear(); // 清除旧的图表数据
                myChartCate.off('click');
                myChartCate.setOption(option, true); // 使用新数据更新图表
                // 添加点击事件
                myChartCate.on('click', async function(params) {
                    var selectedMonth = params.name; // 获取点击的柱形下方的年月，例如 "2024-06"
                    // 分割字符串以提取年份和月份
                    var [year, month] = selectedMonth.split('-');
                    var categoryTitleInput = document.getElementById('applyRemarkInput-1').value;
                    var categoryTitle = categoryTitleInput ? encodeURIComponent(categoryTitleInput) : '';
                    const url =`/api/categories/category-records/${categoryTitle}/${depositoryId}/${year}/${month}`;
                    $.ajax({
                        url: url,
                        type: 'GET',
                        dataType: 'json',
                        success: function(records) {
                            var widthPercentage = 80;
                            var heightPercentage = 80;

                            var screenWidth = $(window).width();
                            var screenHeight = $(window).height();

                            var popupWidth = (widthPercentage / 100) * screenWidth;
                            var popupHeight = (heightPercentage / 100) * screenHeight;

                            var maxPopupWidth = 2800;
                            var maxPopupHeight = 2600;

                            popupWidth = Math.min(popupWidth, maxPopupWidth);
                            popupHeight = Math.min(popupHeight, maxPopupHeight);

                            layer.open({
                                type: 1,
                                title: selectedMonth, // 显示选择的年月
                                content: $('#recordTableContainer2'),
                                area: [popupWidth + 'px', popupHeight + 'px'],
                                shadeClose: true, // 点击遮罩关闭
                                closeBtn: 1, // 显示关闭按钮
                                success: function(layero, index) {
                                }
                            });
                            renderTable2(records);

                        },
                        error: function(error) {
                            console.log("Error fetching records for category", error);
                        }
                    });
                });
                function renderTable2(records) {
                    function formatDate(dateStr) {
                        if (!dateStr) return '';
                        let date = new Date(dateStr);
                        let year = date.getFullYear();
                        let month = (date.getMonth() + 1).toString().padStart(2, '0');
                        let day = date.getDate().toString().padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    }

                    table.render({
                        elem: '#recordTable2',
                        height: "full-50",
                        cols: [ [
                            { field: 'sourceTable', title: '来源表',  hide: true},
                            { field: 'id', title: 'ID', hide: true},
                            {
                                field: 'atId',
                                title: 'AT',
                                templet: function(d) {
                                    return d.atId ? d.atId : '一次性';
                                }
                            },
                            { field: 'name', title: '名称' },
                            { field: 'model', title: '型号'},
                            { field: 'quantity', title: '数量'},
                            // { field: 'unitPrice', title: '单价' },
                            { field: 'totalAmount', title: '金额', templet: function(d) {
                                    return parseFloat(d.totalAmount).toFixed(2);
                                }},
                            {
                                field: 'recordDate',
                                title: '记录日期',
                                hide: true,
                                flex:1,
                                templet: function(d) {
                                    return formatDate(d.recordDate);
                                }
                            },
                            { field: 'applyRemark', title: '备注' ,hide: true},
                            { field: 'categoryTitle', title: '分类标题' ,hide: true}
                        ]],
                        limit: records.length,
                        data: records,
                    });
                }

            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }
        function handleDepositoryChange() {
            var depositoryId = document.getElementById('depository-selector-three').value;
            var catedepositoryId = (depositoryId === 1) ? "sab" : "zab";
            // // 清空之前的分类选择器内容 有BUG
            // document.getElementById('ID-dropdown-demo-complex-1').innerText = '选择分类';
            // document.getElementById('applyRemarkInput-1').value = '';
            loadCategoryData(catedepositoryId, function(data) {
                if (depositoryId === 1) {
                    dropDataSAB = data;
                    loadDepositoryDataForElem('#ID-dropdown-demo-complex-1', dropDataSAB);
                } else {
                    dropDataZAB = data;
                    loadDepositoryDataForElem('#ID-dropdown-demo-complex-1', dropDataZAB);
                }
                // 重新加载数据后调用fetchCateChart以确保图表更新
                fetchCateChart();
            });
        }
        document.getElementById('year-selector-three').addEventListener('click', handleDepositoryChange);

        // 初始化ECharts实例
        // var myChart = echarts.init(document.getElementById('typeAmountChart')); // 请确保您的div有一个ID，例如typeAmountChart
        // function fetchTypeAmountDataAndRenderChart() {
        //     var year = document.getElementById('year-selector').value;
        //     var depositoryId = document.getElementById('depository-selector-two').value;
        //     var typeId = document.getElementById('typeSelect').value;
        //
        //     var url = '/type-amounts/' + year + '/' + typeId + '/' + depositoryId;
        //     // var url = '/CategoryForYear/' + year + '/' + depositoryId + '/' +"N沟" ;
        //     $.get(url, function(data) {
        //         var colors = ['#5470C6'];
        //         var option = {
        //             title: { text: '产量柱形图' },
        //             tooltip: {
        //                 trigger: 'axis',
        //                 axisPointer: { type: 'shadow' }
        //             },
        //             xAxis: { data: data.map(function(item) { return item.month; }) },
        //             yAxis: [
        //                 { type: 'value', position: 'left' },
        //                 { type: 'value', position: 'right', show: true, splitLine: { show: false } }
        //             ],
        //             series: [
        //                 {
        //                     name: '金额',
        //                     type: 'bar',
        //                     yAxisIndex: 0,
        //                     data: data.map(function(item) { return item.monthlyAmount; }),
        //                     label: { normal: { show: true, position: 'top' } },
        //                     itemStyle: { normal: { color: function(params) { return colors[params.dataIndex % colors.length]; } } }
        //                 },
        //                 {
        //                     name: '单价',
        //                     type: 'line',
        //                     yAxisIndex: 1,
        //                     data: data.map(function(item) { return item.unitPrice; }),
        //                     smooth: true,
        //                     label: { normal: { show: true, position: 'top' } },
        //                 }
        //             ]
        //         };
        //         myChart.clear(); // 清除旧的图表数据
        //         myChart.setOption(option, true); // 使用新数据更新图表，第二个参数为 true 表示不合并
        //     });
        // }
        // document.getElementById('depository-selector-two').addEventListener('change', fetchTypeAmountDataAndRenderChart);
        // document.getElementById('year-selector').addEventListener('change', fetchTypeAmountDataAndRenderChart);
        // document.getElementById('typeSelect').addEventListener('change', fetchTypeAmountDataAndRenderChart);

        // 为厂区选择器添加事件监听器
        document.getElementById('depository-selector').addEventListener('change', function() {
            var selectedMonth = document.getElementById('month-selector').value;
            if (selectedMonth) {
                fetchDataForMonth(selectedMonth);
            }
        });
        var legendData = ['金额', '单个成本'];
        var chart1;
        var chart2;
        function fetchDataForMonth(monthRange) {
            var selectedDepositoryId = document.getElementById('depository-selector').value;
            if (selectedDepositoryId) {
                var parts = monthRange.split(' - '); // 拆分开始和结束月份
                var startMonth = parts[0];
                var endMonth = parts[1];

                // 生成开始和结束月份之间的所有月份数组
                var yearMonths = getMonthRangeArray(startMonth, endMonth);

                // 使用所有月份的数组来获取数据
                let requests = yearMonths.map(yearMonth => {
                    let parts = yearMonth.split('-');
                    let year = parts[0];
                    let month = parts[1];

                    return $.ajax({
                        url: `/category-outbounds/${year}/${month}/${selectedDepositoryId}`,
                        type: 'GET',
                        dataType: 'json',
                    });
                });

                // 并行请求多个月份的数据
                Promise.all(requests)
                    .then(allData => {
                        // 将多个月份的数据合并
                        let mergedData = mergeMonthlyData(allData);

                        // 获取 lineData 数据，处理方式同上
                        let lineDataRequests = yearMonths.map(yearMonth => {
                            let parts = yearMonth.split('-');
                            let year = parts[0];
                            let month = parts[1];

                            return $.ajax({
                                url: `/lineData/${year}/${month}`,
                                type: 'GET',
                                dataType: 'json',
                            });
                        });

                        Promise.all(lineDataRequests)
                            .then(allLineData => {
                                // 检查是否有任何一个月份没有数据
                                let hasEmptyData = allLineData.some(data => data.count === 0);
                                console.log("数据:",allLineData );
                                // 如果有任何数据为空，将 mergedLineData 设为空
                                let mergedLineData = hasEmptyData ? [] : mergeLineData(allLineData);

                                // 初始化图表
                                initCategoryBarChart(mergedData, mergedLineData);
                                initOtherCategoryBarChart(mergedData, mergedLineData);
                                initModelBarChart(mergedData, mergedLineData);
                                initModelBarChartTwo(mergedData, mergedLineData);

                                // 同步图例
                                if (chart1 && chart2) {
                                    syncLegend(chart1, chart2);
                                }
                            })
                            .catch(error => {
                                console.log("Error fetching line data：获取行数据时出错", error);
                            });
                    })
                    .catch(error => {
                        console.log("Error fetching category outbounds for multiple months：", error);
                    });
            } else {
                alert("请先选择一个厂区！");
            }
        }

        // 辅助函数：生成开始和结束月份之间的所有月份数组
        function getMonthRangeArray(startMonth, endMonth) {
            var start = moment(startMonth, 'YYYY-MM');
            var end = moment(endMonth, 'YYYY-MM');
            var result = [];

            while (start <= end) {
                result.push(start.format('YYYY-MM'));
                start.add(1, 'month');
            }

            return result;
        }

// 合并多个月份的 category-outbounds 数据
        function mergeMonthlyData(allData) {
            let mergedDataMap = {};

            allData.forEach(monthData => {
                monthData.forEach(item => {
                    if (mergedDataMap[item.category]) {
                        mergedDataMap[item.category].amount += item.amount;
                    } else {
                        mergedDataMap[item.category] = { ...item };
                    }
                });
            });

            return Object.values(mergedDataMap);
        }

// 合并多个月份的 lineData 数据
        function mergeLineData(allLineData) {
            let mergedLineDataMap = {};

            allLineData.forEach(lineDataArray => {
                lineDataArray.data.forEach(item => {
                    // 使用 lineName 和 model 作为合并的键
                    const key = `${item.lineName}-${item.model}`;
                    if (mergedLineDataMap[key]) {
                        mergedLineDataMap[key].production += item.production;
                    } else {
                        mergedLineDataMap[key] = { ...item };
                    }
                });
            });
            return Object.values(mergedLineDataMap);
        }

        miniTab.listen();

        /**
         * 查看公告信息
         **/
        $('body').on('click', '.layuimini-notice', function () {
            var title = $(this).children('.layuimini-notice-title').text(),
                noticeTime = $(this).children('.layuimini-notice-extra').text(),
                content = $(this).children('.layuimini-notice-content').html();
            var html = '<div style="padding:15px 20px; text-align:justify; line-height: 22px;border-bottom:1px solid #e2e2e2;background-color: #2f4056;color: #ffffff">\n' +
                '<div style="text-align: center;margin-bottom: 20px;font-weight: bold;border-bottom:1px solid #718fb5;padding-bottom: 5px"><h4 class="text-danger">' + title + '</h4></div>\n' +
                '<div style="font-size: 12px">' + content + '</div>\n' +
                '</div>\n';
            parent.layer.open({
                type: 1,
                title: '系统公告'+'<span style="float: right;right: 1px;font-size: 12px;color: #b1b3b9;margin-top: 1px">'+noticeTime+'</span>',
                area: '300px;',
                shade: 0.8,
                id: 'layuimini-notice',
                btn: ['取消'],
                btnAlign: 'c',
                moveType: 1,
                content:html,
            });
        });

        /**
         * 图功能
         */
        laydate.render({
            elem: '#year-selector0',
            type: 'year',
            done: function(value, date, endDate){
                // 当选择年份后，调用 fetchData 函数
                // fetchData(value);
                fetchVlure(value);
            }
        });
        // 根据年份加载库存数据
        function fetchVlure(year) {
            if (year) {
                var url = '/getMonthlyReport/' + year; // 拼接年份到URL
                table.render({
                    elem: '#inventory-table',
                    url: url, // 数据接口
                    height: 450, // 表格高度
                    parseData: function (res) { // 解析后端返回的数据
                        return {
                            "code": res.code, // layui要求的状态码
                            "msg": res.msg, // layui要求的提示文本
                            "count": res.count, // 数据总条数
                            "data": res.data // 数据列表
                        };
                    },
                    response: {
                        statusName: 'code', // 规定数据状态的字段名称，后端返回的是'code'
                        statusCode: 0, // 规定成功的状态码，layui默认0表示成功
                        msgName: 'msg', // 规定状态信息的字段名称，后端返回的是'msg'
                        countName: 'count', // 规定数据总数的字段名称，后端返回的是'count'
                        dataName: 'data' // 规定数据列表的字段名称，后端返回的是'data'
                    },
                    cols: [ [
                        {field: 'month',
                            title: '月份', sort: true,width:'15%',templet: function(d) {
                                // 只显示月份部分 (将 '2024-01-31' 改为 '2024-01')
                                return d.month.substring(0, 7);}},
                        {field: 'inboundAmount',
                            title: '入库金额', sort: true,width:'20%', templet: function(d) {
                                // 金额保留整数
                                return Math.round(d.inboundAmount);}},
                        {
                            field: 'outboundAmount',
                            title: '出库金额',width:'20%',
                            sort: true,
                            templet: function(d) {
                                // 金额保留整数
                                return Math.round(d.outboundAmount);
                            }
                        },
                        {
                            field: 'inventoryAmount',
                            title: '期末库存',width:'20%',
                            sort: true,
                            templet: function(d) {
                                // 金额保留整数
                                return Math.round(d.inventoryAmount);
                            }
                        },  {
                            field: 'turnoverRate',
                            title: '库存周转率',width:'15%',
                            templet: function(d) {
                                // 计算库存周转率 = 出库金额 / 期末库存金额
                                if (d.inventoryAmount !== 0) {
                                    return ((d.outboundAmount / d.inventoryAmount) * 100).toFixed(2) + '%';  // 保留两位小数并转为百分比
                                } else {
                                    return 'N/A';  // 避免除以0的情况
                                }
                            }
                        }
                    ]],
                    done: function(res, curr, count) {
                        // 计算各列的平均值
                        let totalInbound = 0;
                        let totalOutbound = 0;
                        let totalInventory = 0;
                        let totalTurnoverRate = 0;
                        let validTurnoverEntries = 0;
                        let months = [], inboundData = [], outboundData = [], inventoryData = [], turnoverRateData= [];

                        res.data.forEach(function(item) {
                            totalInbound += item.inboundAmount;
                            totalOutbound += item.outboundAmount;
                            totalInventory += item.inventoryAmount;
                            months.push(item.month.substring(0, 7)); // 月份
                            inboundData.push(Math.round(item.inboundAmount)); // 入库金额
                            outboundData.push(Math.round(item.outboundAmount)); // 出库金额
                            if (item.inboundAmount === 0 && item.outboundAmount === 0) {
                                inventoryData.push(0); // 库存金额设置为 0
                            } else {
                                inventoryData.push(Math.round(item.inventoryAmount)); // 库存金额
                            }
                            if (item.inventoryAmount !== 0) {
                                let turnoverRate = (item.outboundAmount / item.inventoryAmount) * 100;
                                turnoverRateData.push(turnoverRate.toFixed(2)); // 保留两位小数并存储
                                totalTurnoverRate += turnoverRate;
                                validTurnoverEntries++;
                            } else {
                                turnoverRateData.push(0); // 避免除以0的情况
                            }
                        });
                        let firstZeroIndex = turnoverRateData.findIndex(value => value === "0.00");
                        if (firstZeroIndex > 0) {
                            turnoverRateData[firstZeroIndex - 1] = "0.00"; // 将前一位设置为"0.00"
                        }
                        let nonZeroValues = turnoverRateData.filter(value => value !== "0.00");
                        // 计算平均值
                        let avgInbound = (totalInbound / res.data.length).toFixed(0);
                        let avgOutbound = (totalOutbound / res.data.length).toFixed(0);
                        let avgInventory = (totalInventory / res.data.length).toFixed(0);
                        let avgTurnoverRate = (nonZeroValues.length !== 0) ? (nonZeroValues.reduce((sum, val) => sum + parseFloat(val), 0) / nonZeroValues.length).toFixed(2) + '%' : 'N/A';
                        console.log(avgTurnoverRate);

                        // 在表格底部插入一行平均值
                        $('div.layui-table-box .layui-table-main tbody').append(`
                            <tr class="layui-table-total">
                                <td>平均值</td>
                                <td>${avgInbound}</td>
                                <td>${avgOutbound}</td>
                                <td>${avgInventory}</td>
                                <td>${avgTurnoverRate}</td>
                            </tr>
                        `);
                        // 绘制柱形图
                        var barChart = echarts.init(document.getElementById('inventory-bar-chart'));
                        var barOption = {
                            title: {
                                text: '月度库存分析',
                                left: 'center'
                            },
                            grid: {
                                left: '5%',   // 图表左边距
                                right: '5%',  // 图表右边距
                                // top: '15%',    // 图表上边距
                                // bottom: '15%'  // 图表下边距
                            },
                            tooltip: {
                                trigger: 'axis'
                            },
                            legend: {
                                data: ['入库金额', '出库金额', '期末库存'],
                                left: 'right',
                            },
                            xAxis: {
                                type: 'category',
                                data: months
                            },
                            yAxis: {
                                type: 'value'
                            },
                            series: [
                                {
                                    name: '入库金额',
                                    type: 'bar',
                                    data: inboundData.map((amount, index) => {
                                        const diff = amount - outboundData[index]; // 计算差值
                                        const distance = Math.abs(diff) < 300000 ? 30 : 10;
                                        return {
                                            value: amount,
                                            label: {
                                                distance: distance
                                            }
                                        };
                                    }),
                                    barWidth: 20, // 设置柱形宽度为20
                                    label: {
                                        normal: { show: true, position: 'top', formatter: function(params) { return params.value.toLocaleString(); } } },
                                },
                                {
                                    name: '出库金额',
                                    type: 'bar',
                                    data: outboundData,
                                    barWidth: 20, // 设置柱形宽度为20
                                    label: { normal: { show: true, position: 'top', formatter: function(params) { return params.value.toLocaleString(); } } },
                                    z: 10 // 将 z 设为较大值，保证该系列在最上层
                                },
                                {
                                    name: '期末库存',
                                    type: 'bar',
                                    data: inventoryData,
                                    barWidth: 20, // 设置柱形宽度为20
                                    label: { normal: { show: true, position: 'top', formatter: function(params) { return params.value.toLocaleString(); } } },
                                },
                                // {
                                //     name: '库存折线',
                                //     type: 'line',
                                //     data: inventoryData,
                                //     yAxisIndex: 0,
                                //     symbol: 'circle', // 可调整的符号
                                //     symbolSize: [8, 8] // 符号大小
                                // }
                            ]
                        };
                        barChart.setOption(barOption);
                        // 初始化周转率分析的柱形图
                        var turnoverChart = echarts.init(document.getElementById('turnover-bar-chart'));
                        var turnoverOption = {
                            title: {
                                text: '月度库存周转率分析',
                                left: 'center'
                            },
                            tooltip: {
                                trigger: 'axis',
                                formatter: function (params) {
                                    var result = params[0].name + '<br/>';
                                    params.forEach(function (item) {
                                        result += item.marker + item.seriesName + ': ' + item.value + '%' + '<br/>';
                                    });
                                    return result;
                                }
                            },
                            xAxis: {
                                type: 'category',
                                data: months // 使用月份作为X轴数据
                            },
                            yAxis: {
                                type: 'value',
                                axisLabel: {
                                    formatter: '{value}%' // Y轴显示为百分比
                                }
                            },
                            series: [
                                {
                                    name: '库存周转率',
                                    type: 'bar',
                                    data: turnoverRateData, // 使用计算得出的周转率数据
                                    label: {
                                        normal: {
                                            show: true,
                                            position: 'top',
                                            formatter: '{c}%' // 显示为百分比
                                        }
                                    },
                                    itemStyle: { normal: { color: '#61a0a8' } },
                                    markLine: {
                                        data: [
                                            {
                                                name: '平均周转率',
                                                yAxis: parseFloat(avgTurnoverRate),
                                                label: {
                                                    normal: {
                                                        show: true,
                                                        formatter: '{c}%' // 显示为百分比
                                                    }
                                                },
                                            }, // 使用实际数值
                                        ],
                                        lineStyle: { type: 'dashed', color: '#d48265' }
                                    }
                                },
                            ]
                        };
                        // 渲染周转率柱形图
                        turnoverChart.setOption(turnoverOption);
                    },
                });
            }
        }
        // $(document).ready(function () {
        //     // 页面加载时获取当前年份并调用 fetchData 函数
        //     var year = new Date().getFullYear();
        //     fetchData(year);
        // });

        // function fetchData(year) {
        //     $.ajax({
        //         url: '/monthly-amounts/' + year,
        //         type: 'GET',
        //         dataType: 'json',
        //         success: function (data) {
        //             // 当成功获取数据时，初始化并设置 ECharts 图表
        //             initECharts(data);
        //         },
        //         error: function (error) {
        //             console.log("Error fetching data", error);
        //         }
        //     });
        // }

        // var echartsInstances = [];
        // function initECharts(data) {
        //     var months = data.map(item => {
        //         var dateParts = item.month.split("-");
        //         return dateParts[1] + '月';  // 返回“月份 + '月'”格式
        //     });
        //
        //     // 入库金额图
        //     var sabInbound = data.map(item => item.sabInboundAmount);
        //     var zabInbound = data.map(item => item.zabInboundAmount);
        //
        //     // 出库金额图
        //     var sabOutbound = data.map(item => item.sabOutboundAmount);
        //     var zabOutbound = data.map(item => item.zabOutboundAmount);
        //
        //     // 在库金额图
        //     var sabStock = data.map(item => item.sabStockAmount);
        //     var zabStock = data.map(item => item.zabStockAmount);
        //
        //     echartsInstances.push(initChart('inbound-chart', months, sabInbound, zabInbound, '入库金额'));
        //     echartsInstances.push(initChart('outbound-chart', months, sabOutbound, zabOutbound, '出库金额'));
        //     echartsInstances.push(initBarChart('stock-chart', months, sabStock, zabStock, '库存流水'));
        // }
        var totalProductions;
        function initCategoryBarChart(data, lineData) {
            // 汇总相同 lineName 的 production
            var aggregatedLineData = lineData.reduce((acc, item) => {
                if (acc[item.lineName]) {
                    acc[item.lineName].production += item.production;
                } else {
                    acc[item.lineName] = { ...item };
                }
                return acc;
            }, {});

            // 转换回数组
            var aggregatedLineDataArray = Object.values(aggregatedLineData);

            // 获取所有金额数据中的类别
            var categoriesFromData = data
                .map(item => item.category)
                .filter(category => category.includes("线") || category.endsWith("机"));

            // 获取所有产量数据中的类别
            var categoriesFromLineData = aggregatedLineDataArray
                .map(item => item.lineName)
                .filter(lineName => lineName.includes("线") || lineName.endsWith("机"));

            // 合并类别并去重
            var allCategories = [...new Set([...categoriesFromData, ...categoriesFromLineData])];

            // 获取每个类别的产量和金额
            var amounts = allCategories.map(category => {
                var categoryData = data.find(item => item.category === category);
                return categoryData ? categoryData.amount : 0;
            });

            var productions = allCategories.map(category => {
                var lineDataItem = aggregatedLineDataArray.find(item => item.lineName === category);
                return lineDataItem ? lineDataItem.production : 0;
            });

            // 过滤掉金额和产量都为0的类别
            var validCategories = allCategories.filter((category, index) => {
                return productions[index] > 0 || amounts[index] > 0;
            });

            // 排序逻辑保持不变
            validCategories.sort((a, b) => {
                if (a.includes("线") && b.endsWith("机")) {
                    return -1; // "线" 在前
                } else if (a.endsWith("机") && b.includes("线")) {
                    return 1; // "机" 在后
                } else {
                    return a.localeCompare(b);
                }
            });

            console.log(validCategories);

            // 获取有效类别的总金额
            var validAmounts = validCategories.map(category => {
                var categoryData = data.find(item => item.category === category);
                return categoryData ? categoryData.amount : 0;
            });

            // 重新计算有效类别的产量
            var validProductions = validCategories.map(category => {
                var lineDataItem = aggregatedLineDataArray.find(item => item.lineName === category);
                return lineDataItem ? lineDataItem.production : 0;
            });

            var totalProduction = validProductions.reduce((acc, curr) => acc + curr, 0);
            var totalPrice = validAmounts.reduce((acc, curr) => acc + curr, 0);
            var referenceLineValue = (totalPrice / totalProduction).toFixed(3);
            var formattedTotalPrice = totalPrice.toLocaleString();
            totalProductions=totalProduction;
            console.log(totalPrice);
            console.log(totalProduction);
            console.log(referenceLineValue);

            // 计算每个类别的单价，并保留三位小数
            var unitPrices = validAmounts.map((amount, index) => {
                return validProductions[index] > 0 ? parseFloat((amount / validProductions[index]).toFixed(3)) : 0;
            });
        var colors = ['#5470C6', '#91CC75', '#EE6666', '#E87C25', '#FFD85C', '#73C0DE', '#3BA272', '#FC8452', '#9A60B4', '#EA7CCC'];

            var option2 = {
                title: {
                    text: `单能线和数控NC\n\n\n{small|(单个成本：${referenceLineValue}   消耗金额：${formattedTotalPrice}元)}`,
                    left: 'center',
                    top: 'top',
                    textStyle: {
                        fontSize: 16,  // 主标题字体大小
                        fontWeight: 'bold',  // 主标题字体加粗
                        rich: {
                            small: {
                                fontSize: 12,  // 副标题（单个成本和消耗金额）字体大小
                                fontWeight: 'normal',  // 副标题不加粗
                                color: '#666'  // 副标题颜色
                            }
                        }
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                grid: {
                    left: '3%',
                    right: '3%',
                    top: '200px',
                },
                legend: {
                    data: legendData,
                    left: 'right',
                    selected: { '金额': true, '单个成本': true }
                },
                xAxis: {
                    type: 'category',
                    data: validCategories,
                    axisLabel: {
                        interval: 0,
                        rotate: 90,
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '金额',
                        axisLabel: {
                            formatter: '{value}',
                            rotate: 90,
                        },
                    },
                    {
                        type: 'value',
                        name: '单个成本',
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: {
                            formatter: function(value) {
                                return value.toFixed(3);
                            },
                            rotate: 90,
                        },
                    },
                    {
                        type: 'value',
                        name: '',
                        position: 'right',
                        axisLabel: { show: false },
                        axisLine: { show: false },
                        axisTick: { show: false },
                        splitLine: { show: false }
                    }
                ],
                series: [
                    {
                        name: '金额',
                        type: 'bar',
                        data: validAmounts.map((amount, index) => ({
                            value: amount,
                            label: {
                                distance: index % 2 === 0 ? 15 : 2
                            }
                        })),
                        barWidth: '60%',
                        barCategoryGap: '30%',
                        label: {
                            normal: {
                                show: true,
                                position: 'top',
                                formatter: function(params) {
                                    return params.value;
                                }
                            }
                        },
                        itemStyle: {
                            normal: {
                                color: function(params) {
                                    return colors[params.dataIndex % colors.length];
                                }
                            }
                        }
                    },
                    {
                        name: '单个成本',
                        type: 'line',
                        yAxisIndex: 1,
                        data: unitPrices,
                        label: {
                            normal: {
                                show: true,
                                position: 'top',
                                textStyle: {
                                    color: '#000000'
                                },
                            }
                        },
                        lineStyle: {
                            normal: {
                                color: '#bf2222',
                                opacity: 0.5
                            }
                        },
                        itemStyle: {
                            normal: {
                                opacity: 0.5
                            }
                        },
                        markLine: {
                            data: [
                                {
                                    name: '平均',
                                    yAxis: referenceLineValue,
                                    label: {
                                        show: false,
                                        formatter: '{c}',
                                        position: 'middle'
                                    },
                                    lineStyle: {
                                        type: 'solid',
                                        color: '#bf2222'
                                    }
                                }
                            ]
                        }
                    },
                    {
                        name: '产量',
                        type: 'bar',
                        yAxisIndex: 2,
                        data: validProductions,
                        barWidth: '0%',
                        label: {
                            show: false
                        },
                        itemStyle: {
                            opacity: 0
                        }
                    }
                ]
            };

            chart2 = echarts.init(document.getElementById('category-bar-chart'));
            chart2.clear();
            chart2.off('click');
            chart2.setOption(option2);
            chart2.on('click', function (params) {
                var selectedDepositoryId = document.getElementById('depository-selector').value;
                var selectedMonth = document.getElementById('month-selector').value;
                var parts = selectedMonth.split('-');
                var year = parts[0];
                var month = parts[1];
                var encodedCategoryName = encodeURIComponent(params.name);
                $.ajax({
                    url: '/api/categories/category-records/' + encodedCategoryName + '/' + selectedDepositoryId + '/' + year + '/' + month,
                    type: 'GET',
                    dataType: 'json',
                    success: function(records) {
                        var widthPercentage = 80;
                        var heightPercentage = 80;

                        var screenWidth = $(window).width();
                        var screenHeight = $(window).height();

                        var popupWidth = (widthPercentage / 100) * screenWidth;
                        var popupHeight = (heightPercentage / 100) * screenHeight;

                        var maxPopupWidth = 2800;
                        var maxPopupHeight = 2600   ;

                        popupWidth = Math.min(popupWidth, maxPopupWidth);
                        popupHeight = Math.min(popupHeight, maxPopupHeight);

                        layer.open({
                            type: 1,
                            title: params.name,
                            content: $('#recordTableContainer'),
                            area: [popupWidth + 'px', popupHeight + 'px'],
                            shadeClose: true
                        });

                        renderTable(records);
                    },
                    error: function(error) {
                        console.log("Error fetching records for category", error);
                    }
                });
            });
            function renderTable(records) {
                function formatDate(dateStr) {
                    if (!dateStr) return '';
                    let date = new Date(dateStr);
                    let year = date.getFullYear();
                    let month = (date.getMonth() + 1).toString().padStart(2, '0');
                    let day = date.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }

                table.render({
                    elem: '#recordTable',
                    height: "full-50",
                    cols: [ [
                        { field: 'sourceTable', title: '来源表',  hide: true},
                        { field: 'id', title: 'ID', hide: true},
                        {
                            field: 'atId',
                            title: 'AT',
                            templet: function(d) {
                                return d.atId ? d.atId : '一次性';
                            }
                        },
                        { field: 'name', title: '名称' },
                        { field: 'model', title: '型号'},
                        { field: 'quantity', title: '数量'},
                        // { field: 'unitPrice', title: '单价' },
                        { field: 'totalAmount', title: '金额', templet: function(d) {
                                return parseFloat(d.totalAmount).toFixed(2);
                            }},
                        {
                            field: 'recordDate',
                            title: '记录日期',
                            hide: true,
                            flex:1,
                            templet: function(d) {
                                return formatDate(d.recordDate);
                            }
                        },
                        { field: 'applyRemark', title: '备注' ,hide: true},
                        { field: 'categoryTitle', title: '分类标题' ,hide: true}
                    ]],
                    limit: records.length,
                    data: records,
                });
            }
        }
        var totalUnitCost;
        var OtherAllPrice;
        function initOtherCategoryBarChart(data, lineData) {
            // 过滤出 craft 为 "棒材工艺" 的行
            var filteredLineData = lineData.filter(item => item.craft === "棒材工艺");

            // 统计 filteredLineData 中所有 production 的总和
            var totalProductionForCraft = filteredLineData.reduce((acc, curr) => acc + curr.production, 0);

            console.log(totalProductionForCraft);

            var otherCategories = data
                .map(item => item.category)
                .filter(category => !category.includes("线") && !category.endsWith("机"));

            var categories = data
                .map(item => item.category)
                .filter(category => category.includes("线") || category.endsWith("机"));

            console.log(otherCategories);

            var uniqueOtherCategories = [...new Set(otherCategories)].reverse();
            var uniqueCategories = [...new Set(categories)];

            var otherAmounts = uniqueOtherCategories.map(category => {
                var categoryData = data.find(item => item.category === category);
                return categoryData ? categoryData.amount : 0;
            });

            var productions = uniqueCategories.map(category => {
                var lineDataItem = lineData.find(item => item.lineName === category);
                return lineDataItem ? lineDataItem.production : 0;
            });

            // 计算总产量
            var totalProduction = productions.reduce((acc, curr) => acc + curr, 0);

            // 计算单个成本
            var otherUnitPrices = otherAmounts.map((amount, index) => {
                // 如果是"冲床"类别，使用 totalProductionForCraft，否则使用 totalProduction
                var category = uniqueOtherCategories[index];
                if (category === "冲床" && totalProductionForCraft > 0) {
                    return parseFloat((amount / totalProductionForCraft).toFixed(3));
                } else {
                    return totalProduction > 0 ? parseFloat((amount / totalProduction).toFixed(3)) : 0;
                }
            });
            var referenceLineValue = (otherAmounts.reduce((acc, curr) => acc + curr, 0) );
            OtherAllPrice=referenceLineValue;
            var formattedReferenceLineValue = referenceLineValue.toLocaleString();
            // totalUnitCost = otherUnitPrices.reduce((acc, curr) => acc + curr, 0).toFixed(3);
            totalUnitCost = parseFloat((OtherAllPrice / totalProductions).toFixed(3));
            console.log(totalProductions);
            console.log(formattedReferenceLineValue);
            console.log(totalUnitCost);
            var colors = ['#5470C6', '#91CC75', '#EE6666', '#E87C25', '#FFD85C', '#73C0DE', '#3BA272', '#FC8452', '#9A60B4', '#EA7CCC'];
            var option1 = {
                title: {
                    text: `共通工程{small|(单个成本：${totalUnitCost}    消耗金额：${formattedReferenceLineValue}元)}`, // 使用 rich 属性
                    left: 'center',  // 标题居中
                    top: 'top',  // 标题在图表的顶部
                    textStyle: {
                        fontSize: 16,  // 主标题字体大小
                        fontWeight: 'bold',  // 主标题字体加粗
                        rich: {
                            small: {
                                fontSize: 12,  // 副标题（单个成本和消耗金额）字体大小
                                fontWeight: 'normal',  // 副标题不加粗
                                color: '#666'  // 副标题颜色
                            }
                        }
                    }
                },
                legend: {
                    data: legendData,
                    left: 'left',
                    selected: { '金额': true, '单个成本': true },
                    show: false  // 隐藏图例
                },
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                grid: {
                    left: '20%',   // 图表左边距
                    right: '10%',  // 图表右边距
                    // top: '15%',    // 图表上边距
                    // bottom: '15%'  // 图表下边距
                },
                yAxis: {
                    type: 'category',
                    data: uniqueOtherCategories,
                    axisLabel: {
                        interval: 0,
                        rotate: 0,
                        margin: 0,
                        align: 'right',
                        inside: false
                    },
                    position: 'left',
                    z: 10,  // 确保y轴标签在最顶层
                },
                xAxis: [
                    {
                        type: 'value',
                        name: '金额',
                        position: 'top',  // 位置在顶部
                        axisLabel: {
                            formatter: '{value}'  // 显示单位
                        }
                    },
                    {
                        type: 'value',
                        name: '',
                        position: 'bottom',  // 位置在底部
                        axisLabel: {
                            formatter: '{value}'  // 保留两位小数
                        },
                        axisTick: { show: false },  // 隐藏y轴的刻度线
                        splitLine: { show: false }  // 隐藏y轴的网格线
                    }
                ],
                series: [
                    {
                        name: '金额',
                        type: 'bar',
                        data: otherAmounts,
                        label: {
                            normal: {
                                show: true,
                                position: 'right',
                                formatter: function(params) {
                                    return params.value;  // 显示实际金额
                                }
                            }
                        },
                        itemStyle: {
                            normal: {
                                color: function(params) {
                                    return colors[params.dataIndex % colors.length];
                                }
                            }
                        }
                    },
                    {
                        name: '单个成本',
                        type: 'line',
                        xAxisIndex: 1,  // 使用第二个x轴
                        data: otherUnitPrices,
                        label: {
                            normal: {
                                show: true,
                                position: 'top',
                                formatter: function(params) {
                                    return params.value;  // 显示实际单个成本
                                },
                                textStyle: {
                                    color: '#000000'  // 将数字标注颜色设置为黑色
                                }
                            }
                        },
                        lineStyle: {
                            normal: {
                                color: '#bf2222',  // 折线颜色
                                opacity: 0.5  // 设置透明度，将折线虚化
                            }
                        },
                        itemStyle: {
                            normal: {
                                opacity: 0.5  // 设置点的透明度为0，使得点不被显示
                            }
                        },

                    }
                ]
            };

            chart1 = echarts.init(document.getElementById('other-category-bar-chart'));
            chart1.clear();
            chart1.off('click');
            chart1.setOption(option1);
            chart1.on('click', function (params) {
                var selectedDepositoryId = document.getElementById('depository-selector').value;
                var selectedMonth = document.getElementById('month-selector').value;
                var parts = selectedMonth.split('-');
                var year = parts[0];
                var month = parts[1];
                var encodedCategoryName = encodeURIComponent(params.name);
                $.ajax({
                    url: '/api/categories/category-records/' + encodedCategoryName + '/' + selectedDepositoryId + '/' + year + '/' + month,
                    type: 'GET',
                    dataType: 'json',
                    success: function(records) {
                        var widthPercentage = 80;
                        var heightPercentage = 80;

                        var screenWidth = $(window).width();
                        var screenHeight = $(window).height();

                        var popupWidth = (widthPercentage / 100) * screenWidth;
                        var popupHeight = (heightPercentage / 100) * screenHeight;

                        var maxPopupWidth = 2800;
                        var maxPopupHeight = 2600;

                        popupWidth = Math.min(popupWidth, maxPopupWidth);
                        popupHeight = Math.min(popupHeight, maxPopupHeight);

                        layer.open({
                            type: 1,
                            title: params.name,
                            content: $('#recordTableContainer'),
                            area: [popupWidth + 'px', popupHeight + 'px'],
                            shadeClose: true
                        });

                        renderTable(records);
                    },
                    error: function(error) {
                        console.log("Error fetching records for category", error);
                    }
                });
            });
            function renderTable(records) {
                function formatDate(dateStr) {
                    if (!dateStr) return '';
                    let date = new Date(dateStr);
                    let year = date.getFullYear();
                    let month = (date.getMonth() + 1).toString().padStart(2, '0');
                    let day = date.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }

                table.render({
                    elem: '#recordTable',
                    height: "full-50",
                    cols: [ [
                        { field: 'sourceTable', title: '来源表',  hide: true},
                        { field: 'id', title: 'ID', hide: true},
                        {
                            field: 'atId',
                            title: 'AT',
                            templet: function(d) {
                                return d.atId ? d.atId : '一次性';
                            }
                        },
                        { field: 'name', title: '名称' },
                        { field: 'model', title: '型号'},
                        { field: 'quantity', title: '数量'},
                        // { field: 'unitPrice', title: '单价' },
                        { field: 'totalAmount', title: '金额', templet: function(d) {
                                return parseFloat(d.totalAmount).toFixed(2);
                            }},
                        {
                            field: 'recordDate',
                            title: '记录日期',
                            hide: true,
                            flex:1,
                            templet: function(d) {
                                return formatDate(d.recordDate);
                            }
                        },
                        { field: 'applyRemark', title: '备注' ,hide: true},
                        { field: 'categoryTitle', title: '分类标题' ,hide: true}
                    ]],
                    limit: records.length,
                    data: records,
                });
            }
        }
        function initModelBarChart(data, lineData) {
            console.log(data);
            console.log(lineData);
            // 以 model 进行分类汇总
            var modelMap = {};
            var totalProductionMap = {};

            // 首先计算每个 lineName 的总生产量
            lineData.forEach(item => {
                var lineName = item.lineName;
                if (!totalProductionMap[lineName]) {
                    totalProductionMap[lineName] = 0;
                }
                totalProductionMap[lineName] += item.production || 0;
            });

            lineData.forEach(item => {
                var modelKey = item.model || "无规格"; // Use "无规格分类" for empty models
                var lineName = item.lineName;
                if (!modelMap[modelKey]) {
                    modelMap[modelKey] = {
                        amount: 0,
                        production: 0,
                        categories: [] // 添加一个数组来存储相关类别和金额
                    };
                }
                var correspondingData = data.find(d => d.category === item.lineName);
                if (correspondingData) {
                    // 计算分配的 amount
                    var currentProduction = totalProductionMap[lineName];
                    var currentAmount = correspondingData.amount || 0;
                    var allocatedAmount = 0;

                    if (currentProduction > 0) {
                        // 按比例分配金额
                        allocatedAmount = Math.floor(currentAmount * (item.production / currentProduction));
                    } else {
                        // 如果生产量为 0，直接使用总金额
                        allocatedAmount = currentAmount;
                    }

                    modelMap[modelKey].amount += allocatedAmount;

                    // 保存类别和金额信息
                    modelMap[modelKey].categories.push({
                        category: lineName,
                        craft: item.craft,
                        amount: allocatedAmount, // 使用分配后的金额
                        production: item.production || 0 // 在这里添加具体线路的 production
                    });
                }
                modelMap[modelKey].production += item.production || 0;
            });
            console.log(modelMap);

            var categoriesFromData = data
                .map(item => item.category)
                .filter(category => category.includes("线") || category.endsWith("机"));

            // 合并类别并去重
            var allCategories = [...new Set([...categoriesFromData])];

            // 获取每个类别的产量和金额
            var amountsALL = allCategories.map(category => {
                var categoryData = data.find(item => item.category === category);
                return categoryData ? categoryData.amount : 0;
            });

            var models = Object.keys(modelMap);
            console.log(models);
            // 筛选后的 amounts 和 productions
            var amounts = models.map(model => {
                var categories = modelMap[model].categories; // 获取该型号的所有类别
                var filteredCategories = categories.filter(categoryData => categoryData.craft !== "管材工艺"); // 筛选出 craft 不为 "管材工艺" 的类别

                // 计算筛选后的总 amount
                return filteredCategories.reduce((sum, categoryData) => sum + (categoryData.amount || 0), 0);
            });

            console.log(amounts);

            var productions = models.map(model => {
                var categories = modelMap[model].categories; // 获取该型号的所有类别
                var filteredCategories = categories.filter(categoryData => categoryData.craft !== "管材工艺"); // 筛选出 craft 不为 "管材工艺" 的类别

                // 计算筛选后的总 production
                return filteredCategories.reduce((sum, categoryData) => sum + (categoryData.production || 0), 0);
            });

            console.log(productions);

// 计算总产量和总金额
            var totalProduction = productions.reduce((acc, curr) => acc + curr, 0);
            var totalPrice = amounts.reduce((acc, curr) => acc + curr, 0);

// 计算参考线值
//             var referenceLineValue = totalProduction > 0 ? (totalPrice / totalProduction).toFixed(3) : 0;

            console.log(totalPrice);
            console.log(totalProduction);
            console.log(referenceLineValue);

// 确保数值有效
            totalUnitCost = Number(totalUnitCost) || 0;
            totalPrice = Number(totalPrice) || 0;
            OtherAllPrice = Number(OtherAllPrice) || 0;

// 格式化总金额
            var formattedTotalALL = (totalPrice ).toLocaleString();

            var unitPrices = models.map((model) => {
                var modelData = modelMap[model];
                var categories = modelData.categories; // 获取该型号的所有类别
                var filteredCategories = categories.filter(categoryData => categoryData.craft !== "管材工艺"); // 筛选出 craft 不为 "管材工艺" 的类别

                var totalAmount = 0; // 总金额
                var totalProduction = 0; // 总产量

                // 计算总 amount 和总 production
                filteredCategories.forEach((categoryData) => {
                    totalAmount += categoryData.amount || 0; // 累加 amount
                    totalProduction += categoryData.production || 0; // 累加 production
                });

                var finalCost = 0; // 用于保存最终的单价
                if (totalProduction > 0) {
                    finalCost = totalAmount / totalProduction; // 总 amount 除以总 production
                }

                // 如果有其他单位成本 (totalUnitCost)，可以将其加到最终单价上
                finalCost = finalCost > 0 ? (finalCost + totalUnitCost) : finalCost;

                // 返回保留三位小数的最终单价
                return parseFloat(finalCost.toFixed(3));
            });
// 过滤掉金额和产量均为 0 的条目
            var filteredData = models.map((model, index) => {
                var categories = modelMap[model].categories;
                var filteredCategories = categories.filter(categoryData => categoryData.craft !== "管材工艺");

                var amount = filteredCategories.reduce((sum, categoryData) => sum + (categoryData.amount || 0), 0);
                var production = filteredCategories.reduce((sum, categoryData) => sum + (categoryData.production || 0), 0);
                var unitPrice = unitPrices[index];

                return {
                    model,
                    amount,
                    production,
                    unitPrice,
                    valid: amount !== 0 || production !== 0 // 标记有效条目
                };
            }).filter(item => item.valid); // 只保留有效条目

// 提取过滤后的数据
            var filteredModels = filteredData.map(item => item.model);
            var filteredAmounts = filteredData.map(item => item.amount);
            var filteredProductions = filteredData.map(item => item.production);
            var filteredUnitPrices = filteredData.map(item => item.unitPrice);


// 计算参考线值
            var totalAmountAll = filteredData.reduce((sum, item) => sum + item.amount, 0); // 总金额
            var totalProductionAll = filteredData.reduce((sum, item) => sum + item.production, 0); // 总产量

// 计算参考线值：总金额 / 总产量
            var referenceLineValue = totalProductionAll > 0
                ? (totalAmountAll / totalProductionAll).toFixed(3)
                : 0;

            console.log("参考线值:", referenceLineValue);
            referenceLineValue = Number(referenceLineValue) || 0; // 确保是数字
            var colors = ['#5470C6', '#91CC75', '#EE6666', '#E87C25', '#FFD85C', '#73C0DE', '#3BA272', '#FC8452', '#9A60B4', '#EA7CCC'];

            var option = {
                title: {
                    text: `棒材工艺及数控NC成本图\n\n{small|(单个成本：${(referenceLineValue +totalUnitCost).toFixed(3)} 消耗金额：${(formattedTotalALL)}元)}`,
                    left: 'center',
                    top: 'top',
                    textStyle: {
                        fontSize: 16,  // 主标题字体大小
                        fontWeight: 'bold',  // 主标题字体加粗
                        rich: {
                            small: {
                                fontSize: 12,  // 副标题（单个成本和消耗金额）字体大小
                                fontWeight: 'normal',  // 副标题不加粗
                                color: '#666'  // 副标题颜色
                            }
                        }
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                grid: {
                    left: '5%',
                    right: '3%',
                    top: '25%',
                    bottom: '20%'
                },
                legend: {
                    data: ['金额', '单个成本'],
                    left: 'right',
                    selected: { '金额': true, '单个成本': true }
                },
                xAxis: {
                    type: 'category',
                    data: filteredModels,
                    axisLabel: {
                        interval: 0,
                        rotate: 90,
                    }
                },
                yAxis: [
                    { type: 'value', name: '金额', axisLabel: { formatter: '{value}' } },
                    { type: 'value', name: '单个成本', axisTick: { show: false }, splitLine: { show: false }, axisLabel: { formatter: function(value) { return value.toFixed(3); }, } },
                    { type: 'value', name: '', position: 'right', axisLabel: { show: false }, axisLine: { show: false }, axisTick: { show: false }, splitLine: { show: false } }
                ],
                series: [
                    {
                        name: '金额',
                        type: 'bar',
                        data: filteredAmounts,
                        barWidth: '60%',
                        barCategoryGap: '30%',
                        label: { normal: { show: true, position: 'top', formatter: function(params) { return params.value; } } },
                        itemStyle: { normal: { color: function(params) { return colors[params.dataIndex % colors.length]; } } }
                    },
                    {
                        name: '单个成本',
                        type: 'line',
                        yAxisIndex: 1,
                        data: filteredUnitPrices,
                        label: { normal: { show: true, position: 'top', textStyle: { color: '#000000' } } },
                        lineStyle: { normal: { color: '#bf2222', opacity: 0.5 } },
                        itemStyle: { normal: { opacity: 0.5 } },
                        markLine: {
                            data: [
                                {
                                    name: '平均',
                                    yAxis: (referenceLineValue + totalUnitCost),
                                    label: { show: false, formatter: '{c}', position: 'middle' },
                                    lineStyle: { type: 'solid', color: '#bf2222' }
                                }
                            ]
                        }
                    },
                    {
                        name: '产量',
                        type: 'bar',
                        yAxisIndex: 2,
                        data: filteredProductions,
                        barWidth: '0%',
                        label: { show: false },
                        itemStyle: { opacity: 0 }
                    }
                ]
            };

            var modelChart = echarts.init(document.getElementById('model-analysis-chart'));
            modelChart.clear();
            modelChart.setOption(option);
        }

        function initModelBarChartTwo(data, lineData) {
            var modelMap = {};
            var totalProductionMap = {};
            lineData.forEach(item => {
                var lineName = item.lineName;
                if (!totalProductionMap[lineName]) {
                    totalProductionMap[lineName] = 0;
                }
                totalProductionMap[lineName] += item.production || 0;
            });
            lineData.forEach(item => {
                var modelKey = item.model || "无规格"; // Use "无规格分类" for empty models
                var lineName = item.lineName;
                if (!modelMap[modelKey]) {
                    modelMap[modelKey] = {
                        amount: 0,
                        production: 0,
                        categories: [] // 添加一个数组来存储相关类别和金额
                    };
                }
                var correspondingData = data.find(d => d.category === item.lineName);
                if (correspondingData) {
                    // 计算分配的 amount
                    var currentProduction = totalProductionMap[lineName];
                    var currentAmount = correspondingData.amount || 0;
                    var allocatedAmount = 0;

                    if (currentProduction > 0) {
                        // 按比例分配金额
                        allocatedAmount = Math.floor(currentAmount * (item.production / currentProduction));
                    } else {
                        // 如果生产量为 0，直接使用总金额
                        allocatedAmount = currentAmount;
                    }
                    modelMap[modelKey].amount += allocatedAmount;
                    modelMap[modelKey].categories.push({
                        category: lineName,
                        craft: item.craft,
                        amount: allocatedAmount, // 使用分配后的金额
                        production: item.production || 0 // 在这里添加具体线路的 production
                    });
                }
                modelMap[modelKey].production += item.production || 0;
            });
            var categoriesFromData = data
                .map(item => item.category)
                .filter(category => category.includes("线") || category.endsWith("机"));
            var allCategories = [...new Set([...categoriesFromData])];
            var amountsALL = allCategories.map(category => {
                var categoryData = data.find(item => item.category === category);
                return categoryData ? categoryData.amount : 0;
            });
            var models = Object.keys(modelMap);
            console.log(models);
            var amounts = models.map(model => {
                var categories = modelMap[model].categories; // 获取该型号的所有类别
                var filteredCategories = categories.filter(categoryData => categoryData.craft === "管材工艺"); // 筛选出 craft 不为 "管材工艺" 的类别
                return filteredCategories.reduce((sum, categoryData) => sum + (categoryData.amount || 0), 0);
            });
            console.log(amounts);
            var productions = models.map(model => {
                var categories = modelMap[model].categories; // 获取该型号的所有类别
                var filteredCategories = categories.filter(categoryData => categoryData.craft === "管材工艺"); // 筛选出 craft 不为 "管材工艺" 的类别
                return filteredCategories.reduce((sum, categoryData) => sum + (categoryData.production || 0), 0);
            });
            console.log(productions);
            var totalProduction = productions.reduce((acc, curr) => acc + curr, 0);
            var totalPrice = amounts.reduce((acc, curr) => acc + curr, 0);
// 计算参考线值
//             var referenceLineValue = totalProduction > 0 ? (totalPrice / totalProduction).toFixed(3) : 0;
            console.log(totalPrice);
            console.log(totalProduction);
            console.log(referenceLineValue);
// 确保数值有效
            totalUnitCost = Number(totalUnitCost) || 0;
            totalPrice = Number(totalPrice) || 0;
            OtherAllPrice = Number(OtherAllPrice) || 0;
// 格式化总金额
            var formattedTotalALL = (totalPrice ).toLocaleString();

            var unitPrices = models.map((model) => {
                var modelData = modelMap[model];
                var categories = modelData.categories; // 获取该型号的所有类别
                var filteredCategories = categories.filter(categoryData => categoryData.craft === "管材工艺"); // 筛选出 craft 为 "管材工艺" 的类别

                var totalProduction = 0; // 总产量
                var amountA = 0; // category 带有 A 的总金额
                var amountB = 0; // category 带有 B 的总金额
                var productionA = 0; // category 带有 A 的总产量
                var productionB = 0; // category 带有 B 的总产量

                // 对 filteredCategories 进行分类和累加
                filteredCategories.forEach((categoryData) => {
                    totalProduction += categoryData.production || 0; // 累加总生产量
                    if (categoryData.category.includes("A")) {
                        amountA += categoryData.amount || 0;
                        productionA += categoryData.production || 0;
                    } else if (categoryData.category.includes("B")) {
                        amountB += categoryData.amount || 0;
                        productionB += categoryData.production || 0;
                    }
                });

                // 计算单价
                var costA = productionA > 0 ? amountA / productionA : 0; // 带 A 的单个成本
                var costB = productionB > 0 ? amountB / productionB : 0; // 带 B 的单个成本

                var finalCost = costA + costB; // A 和 B 的单个成本求和

                // 如果有其他单位成本 (totalUnitCost)，可以将其加到最终单价上
                finalCost = finalCost > 0 ? (finalCost + totalUnitCost) : finalCost;

                // 返回保留三位小数的最终单价
                return parseFloat(finalCost.toFixed(3));
            });
            // 过滤掉金额和产量均为 0 的条目
            var filteredData = models.map((model, index) => {
                var categories = modelMap[model].categories;
                var filteredCategories = categories.filter(categoryData => categoryData.craft === "管材工艺");

                var amount = filteredCategories.reduce((sum, categoryData) => sum + (categoryData.amount || 0), 0);
                var production = filteredCategories.reduce((sum, categoryData) => sum + (categoryData.production || 0), 0);
                var unitPrice = unitPrices[index];

                return {
                    model,
                    amount,
                    production,
                    unitPrice,
                    valid: amount !== 0 || production !== 0 // 标记有效条目
                };
            }).filter(item => item.valid); // 只保留有效条目

// 提取过滤后的数据
            var filteredModels = filteredData.map(item => item.model);
            var filteredAmounts = filteredData.map(item => item.amount);
            var filteredProductions = filteredData.map(item => item.production);
            var filteredUnitPrices = filteredData.map(item => item.unitPrice);

            // 计算参考线值
            var totalUnitPrices = unitPrices.reduce((acc, price) => acc + (price > 0 ? price : 0), 0); // 单价的总和（排除无效单价）
            var validUnitPricesCount = unitPrices.filter(price => price > 0).length; // 有效单价的数量
            var referenceLineValue = validUnitPricesCount > 0
                ? (totalUnitPrices / validUnitPricesCount).toFixed(3)
                : 0;

            console.log("参考线值:", referenceLineValue);
            referenceLineValue = Number(referenceLineValue) || 0; // 确保是数字

            var colors = ['#5470C6', '#91CC75', '#EE6666', '#E87C25', '#FFD85C', '#73C0DE', '#3BA272', '#FC8452', '#9A60B4', '#EA7CCC'];

            var option = {
                title: {
                    text: `管材工艺成本图\n\n{small|(单个成本：${(referenceLineValue).toFixed(3)} 消耗金额：${(formattedTotalALL)}元)}`,
                    left: 'center',
                    top: 'top',
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 'bold',
                        rich: {
                            small: {
                                fontSize: 12,
                                fontWeight: 'normal',
                                color: '#666'
                            }
                        }
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                grid: {
                    left: '5%',
                    right: '3%',
                    top: '25%',
                    bottom: '20%'
                },
                legend: {
                    data: ['金额', '单个成本'],
                    left: 'right',
                    selected: { '金额': true, '单个成本': true }
                },
                xAxis: {
                    type: 'category',
                    data: filteredModels,
                    axisLabel: {
                        interval: 0,
                        rotate: 90,
                    }
                },
                yAxis: [
                    { type: 'value', name: '金额', axisLabel: { formatter: '{value}' } },
                    { type: 'value', name: '单个成本', axisTick: { show: false }, splitLine: { show: false }, axisLabel: { formatter: value => value.toFixed(3) } },
                    { type: 'value', name: '', position: 'right', axisLabel: { show: false }, axisLine: { show: false }, axisTick: { show: false }, splitLine: { show: false } }
                ],
                series: [
                    {
                        name: '金额',
                        type: 'bar',
                        data: filteredAmounts,
                        barWidth: '60%',
                        barCategoryGap: '30%',
                        label: { normal: { show: true, position: 'top', formatter: params => params.value } },
                        itemStyle: { normal: { color: params => colors[params.dataIndex % colors.length] } }
                    },
                    {
                        name: '单个成本',
                        type: 'line',
                        yAxisIndex: 1,
                        data: filteredUnitPrices,
                        label: { normal: { show: true, position: 'top', textStyle: { color: '#000000' } } },
                        lineStyle: { normal: { color: '#bf2222', opacity: 0.5 } },
                        itemStyle: { normal: { opacity: 0.5 } },
                        markLine: {
                            data: [
                                {
                                    name: '平均',
                                    yAxis: referenceLineValue,
                                    label: { show: false, formatter: '{c}', position: 'middle' },
                                    lineStyle: { type: 'solid', color: '#bf2222' }
                                }
                            ]
                        }
                    },
                    {
                        name: '产量',
                        type: 'bar',
                        yAxisIndex: 2,
                        data: filteredProductions,
                        barWidth: '0%',
                        label: { show: false },
                        itemStyle: { opacity: 0 }
                    }
                ]
            };

            var modelChart = echarts.init(document.getElementById('model-analysisTwo-chart'));
            modelChart.clear();
            modelChart.setOption(option);
        }

        function syncLegend(chart1, chart2) {
            function sync(event, sourceChart, targetChart) {
                if (event.name && event.selected.hasOwnProperty(event.name)) {
                    targetChart.dispatchAction({
                        type: event.selected[event.name] ? 'legendSelect' : 'legendUnSelect',
                        name: event.name
                    });
                }
            }

            chart1.on('legendselectchanged', function(event) {
                sync(event, chart1, chart2);
            });

            chart2.on('legendselectchanged', function(event) {
                sync(event, chart2, chart1);
            });
        }


        function initChart(chartId, months, sabData, zabData, title) {
            var echartsInstance = echarts.init(document.getElementById(chartId), 'walden');
            var option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: "cross",
                        label: { backgroundColor: "#6e7985" }
                    }
                },
                legend: { data: ['SAB', 'ZAB'] },
                title: { text: title, left: 'left' },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                toolbox: { feature: { saveAsImage: {} } },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: months
                },
                yAxis: { type: 'value' },
                series: [
                    {
                        name: 'SAB',
                        type: 'line',
                        smooth: false,
                        label: { normal: { show: true, position: 'left' } },
                        areaStyle: {},
                        data: sabData
                    },
                    {
                        name: 'ZAB',
                        type: 'line',
                        smooth: false,
                        label: { normal: { show: true, position: 'right' } },
                        areaStyle: {},
                        data: zabData
                    }
                ]
            };
            echartsInstance.setOption(option);
            return echartsInstance;
        }

        function initBarChart(chartId, months, sabData, zabData, title) {
            var echartsInstance = echarts.init(document.getElementById(chartId), 'walden');
            var option = {
                tooltip: { trigger: 'axis' },
                legend: { data: ['SAB', 'ZAB'] },
                title: { text: title, left: 'left' },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                toolbox: { feature: { saveAsImage: {} } },
                xAxis: { type: 'category', data: months },
                yAxis: { type: 'value' },
                series: [
                    {
                        name: 'SAB',
                        type: 'bar',
                        barGap: '1%',
                        label: { normal: { show: true, position: 'top' } },
                        data: sabData
                    },
                    {
                        name: 'ZAB',
                        type: 'bar',
                        barGap: '1%',
                        label: { normal: { show: true, position: 'top' } },
                        data: zabData,
                    }
                ]
            };
            echartsInstance.setOption(option);
            return echartsInstance;
        }

        // window.onresize = function(){
        //     for (var i = 0; i < echartsInstances.length; i++) {
        //         echartsInstances[i].resize();
        //     }
        // }
    });

</script>
</body>
</html>