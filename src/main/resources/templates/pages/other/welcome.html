<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>首页</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/static/lib/layui-v2.6.3/css/layui.css" media="all">
    <link rel="stylesheet" href="/static/lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all">
    <link rel="stylesheet" href="/static/css/public.css" media="all">
    <!--[if lt IE 9]>
    <script src="/static/js/otherJs/cdn.staticfile.org_html5shiv_r29_html5.min.js"></script>
    <script src="/static/js/otherJs/cdn.staticfile.org_respond.js_1.4.2_respond.min.js"></script>
    <![endif]-->
    <style>
        .layui-card {border:1px solid #f2f2f2;border-radius:5px;}
        .icon {margin-right:10px;color:#1aa094;}
        .icon-cray {color:#ffb800!important;}
        .icon-blue {color:#1e9fff!important;}
        .icon-tip {color:#ff5722!important;}
        .layuimini-qiuck-module {text-align:center;margin-top: 10px}
        .layuimini-qiuck-module a i {display:inline-block;width:100%;height:60px;line-height:60px;text-align:center;border-radius:2px;font-size:30px;background-color:#F8F8F8;color:#333;transition:all .3s;-webkit-transition:all .3s;}
        .layuimini-qiuck-module a cite {position:relative;top:2px;display:block;color:#666;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;font-size:14px;}
        .welcome-module {width:100%;height:210px;}
        .panel {background-color:#fff;border:1px solid transparent;border-radius:3px;-webkit-box-shadow:0 1px 1px rgba(0,0,0,.05);box-shadow:0 1px 1px rgba(0,0,0,.05)}
        .panel-body {padding:10px}
        .panel-title {margin-top:0;margin-bottom:0;font-size:12px;color:inherit}
        .label {display:inline;padding:.2em .6em .3em;font-size:75%;font-weight:700;line-height:1;color:#fff;text-align:center;white-space:nowrap;vertical-align:baseline;border-radius:.25em;margin-top: .3em;}
        .layui-red {color:red}
        .main_btn > p {height:40px;}
        .layui-bg-number {background-color:#F8F8F8;}
        .layuimini-notice-container {
            max-height: 200px; /* 设置一个最大高度 */
            overflow-y: auto; /* 添加垂直滚动条 */
        }
        /* 保持其他样式不变 */
        .layuimini-notice:hover {background:#f6f6f6;}
        .layuimini-notice {padding:7px 16px;clear:both;font-size:12px !important;cursor:pointer;position:relative;transition:background 0.2s ease-in-out;}
        .layuimini-notice-title,.layuimini-notice-label {
            padding-right: 70px !important;text-overflow:ellipsis!important;overflow:hidden!important;white-space:nowrap!important;}
        .layuimini-notice-title {line-height:28px;font-size:14px;}
        .layuimini-notice-extra {position:absolute;top:50%;margin-top:-8px;right:16px;display:inline-block;height:16px;color:#999;}
        .layui-table-view .layui-table-body tr.layui-table-hover {
            background-color: #f2f2f2; /* 高亮行的背景色，可根据需要调整 */
        }

        .layui-table-view .layui-table-body tr td {
            padding: 2px 8px; /* 减少行内间距 */
            line-height: 1.2; /* 调整行高 */
        }

        .layui-table-view .layui-table-header tr th {
            padding: 2px 8px; /* 减少标题行内间距 */
            line-height: 1.2; /* 调整标题行高 */
        }
        .custom-input {
            text-align: left;  /* 使内容左对齐 */
        }


    </style>
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">
        <div class="layui-row layui-col-space8">
            <div class="layui-col-md4">
                <div class="layui-row layui-col-space10">
                    <div class="layui-col-md15">
                        <div class="layui-card">
                            <div class="layui-card-header"><i class="fa fa-signal icon"></i>数据统计（不包含呆滞仓数据）</div>
                            <div class="layui-card-body">
                                <div class="welcome-module">
                                    <div class="layui-row layui-col-space10">
                                        <div class="layui-col-xs6">
                                            <div class="panel layui-bg-number">
                                                <div class="panel-body">
                                                    <div class="panel-title">
                                                        <span class="label pull-right layui-bg-blue">A</span>
                                                        <h5>SAB在库金额</h5>
                                                    </div>
                                                    <div class="panel-content">
                                                        <h1 th:text="${SABpriceSum}"></h1>
                                                        <small>SAB在库金额  CNY</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-col-xs6">
                                            <div class="panel layui-bg-number">
                                                <div class="panel-body">
                                                    <div class="panel-title">
                                                        <span class="label pull-right layui-bg-cyan">B</span>
                                                        <h5>ZAB在库金额</h5>
                                                    </div>
                                                    <div class="panel-content">
                                                        <h1 th:text="${ZABpriceSum}"></h1>
                                                        <small>ZAB在库金额  CNY</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-col-xs6">
                                            <div class="panel layui-bg-number">
                                                <div class="panel-body">
                                                    <div class="panel-title">
                                                        <span class="label pull-right layui-bg-orange">C</span>
                                                        <h5>SAB在库数</h5>
                                                    </div>
                                                    <div class="panel-content">
                                                        <h1 th:text="${SABcountSum}"></h1>
                                                        <small>SAB在库数</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-col-xs6">
                                            <div class="panel layui-bg-number">
                                                <div class="panel-body">
                                                    <div class="panel-title">
                                                        <span class="label pull-right layui-bg-green">D</span>
                                                        <h5>ZAB在库数</h5>
                                                    </div>
                                                    <div class="panel-content">
                                                        <h1 th:text="${ZABcountSum}"></h1>
                                                        <small>ZAB在库数</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="layui-col-md4" style="display: none;">
                        <div class="layui-card">
                            <div class="layui-card-header"><i class="fa fa-credit-card icon icon-blue"></i>快捷入口</div>
                            <div class="layui-card-body">
                                <div class="welcome-module">
                                    <div class="layui-row layui-col-space10 layuimini-qiuck">
                                        <!-- 入库申请 -->
                                        <div class="layui-col-xs3 layuimini-qiuck-module">
                                            <a href="javascript:;" layuimini-content-href="/application_in" data-title="入库申请" data-icon="fa fa-arrow-down">
                                                <i class="fa fa-arrow-down"></i>
                                                <cite>入库申请</cite>
                                            </a>
                                        </div>
                                        <!-- 出库申请 -->
                                        <div class="layui-col-xs3 layuimini-qiuck-module">
                                            <a href="javascript:;" layuimini-content-href="/application_out" data-title="出库申请" data-icon="fa fa-arrow-up">
                                                <i class="fa fa-arrow-up"></i>
                                                <cite>出库申请</cite>
                                            </a>
                                        </div>
                                        <!-- 转移申请 -->
                                        <div class="layui-col-xs3 layuimini-qiuck-module">
                                            <a href="javascript:;" layuimini-content-href="/application_transfer" data-title="转移申请" data-icon="fa fa-exchange">
                                                <i class="fa fa-exchange"></i>
                                                <cite>转移申请</cite>
                                            </a>
                                        </div>
                                        <!-- 一次性填写 -->
                                        <div class="layui-col-xs3 layuimini-qiuck-module">
                                            <a href="javascript:;" layuimini-content-href="/once_add" data-title="一次性填写" data-icon="fa fa-pencil-alt">
                                                <i class="fa fa-pencil"></i>
                                                <cite>一次性填写</cite>
                                            </a>
                                        </div>
                                        <!-- 入库查询 -->
                                        <div class="layui-col-xs3 layuimini-qiuck-module">
                                            <a href="javascript:;" layuimini-content-href="/table_in" data-title="入库查询" data-icon="fa fa-search">
                                                <i class="fa fa-search-plus"></i>
                                                <cite>入库查询</cite>
                                            </a>
                                        </div>
                                        <!-- 出库查询 -->
                                        <div class="layui-col-xs3 layuimini-qiuck-module">
                                            <a href="javascript:;" layuimini-content-href="/table_out" data-title="出库查询" data-icon="fa fa-search">
                                                <i class="fa fa-search-minus"></i>
                                                <cite>出库查询</cite>
                                            </a>
                                        </div>
                                        <!-- 库存查询 -->
                                        <div class="layui-col-xs3 layuimini-qiuck-module">
                                            <a href="javascript:;" layuimini-content-href="/table_stock" data-title="库存查询" data-icon="fa fa-search">
                                                <i class="fa fa-list-alt"></i>
                                                <cite>库存查询</cite>
                                            </a>
                                        </div>
                                        <!-- 一次性报表 -->
                                        <div class="layui-col-xs3 layuimini-qiuck-module">
                                            <a href="javascript:;" layuimini-content-href="/once_table" data-title="一次性报表" data-icon="fa fa-pie-chart">
                                                <i class="fa fa-pie-chart"></i>
                                                <cite>一次性报表</cite>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 公告数据表格容器 -->
            <div class="layui-col-md8">
                <div class="layui-card">
                    <div class="layui-card-header"><i class="fa fa-bullhorn icon icon-tip"></i>安全库存警报(在库为0)</div>
                    <div class="layui-card-body">
                        <table id="noticeTable" lay-filter="noticeTable"></table>
                    </div>
                </div>
            </div>
        </div>
        <input class="layui-input" type="text" id="year-selector0" placeholder="请选择查看的年份" autocomplete="off">
        <div class="layui-row">
            <!-- 入库金额折线图 -->
            <div class="layui-col-md6">
                <div class="layui-card">
                    <div class="layui-card-header"><i class="fa fa-signal icon"></i>入库折线图</div>
                    <div class="layui-card-body">
                        <div id="inbound-chart" style="width: 100%; height: 500px;"></div>
                    </div>
                </div>
            </div>
            <!-- 出库金额折线图 -->
            <div class="layui-col-md6">
                <div class="layui-card">
                    <div class="layui-card-header"><i class="fa fa-signal icon"></i>出库折线图</div>
                    <div class="layui-card-body">
                        <div id="outbound-chart" style="width: 100%; height: 500px;"></div>
                    </div>
                </div>
            </div>
        </div>
<!--        <div class="layui-row">-->
<!--            &lt;!&ndash; 在库金额柱形图 &ndash;&gt;-->
<!--            <div class="layui-col-md12">-->
<!--                <div class="layui-card">-->
<!--                    <div class="layui-card-header"><i class="fa fa-signal icon"></i>在库金额柱形图</div>-->
<!--                    <div class="layui-card-body">-->
<!--                        <div id="stock-chart" style="width: 100%; height: 500px;"></div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
        <div>
            <select id="depository-selector">
                <option value="">选择厂区</option>
                <option value="1">SAB</option>
                <option value="2">ZAB</option>
            </select>
            <input type="text" id="month-selector" placeholder="请选择年月" autocomplete="off">
            <div class="layui-row">
<!--&lt;!&ndash;                 左侧显示其他类别的柱形图 &ndash;&gt;-->
<!--                <div class="layui-col-md12">-->
<!--                    <div class="layui-card">-->
<!--                        <div class="layui-card-header"><i class="fa fa-signal icon"></i>其他类别分析图</div>-->
<!--                        &lt;!&ndash; 左侧的横向条形图 &ndash;&gt;-->
<!--                        <div id="other-category-bar-chart" style="width: 100%; height: 550px; margin-left: 2px;"></div>-->
<!--                    </div>-->
<!--                </div>-->
                <!-- 各工程使用金额分析图 -->
                <div class="layui-col-md12">
                    <div class="layui-card">
                        <div class="layui-card-header"><i class="fa fa-signal icon"></i>各工程使用成本分析图</div>

                        <div class="layui-card-body" style="display: flex; align-items: flex-start;">
                            <div id="other-category-bar-chart" style="width: 35%; height: 800px; margin-left: 15px;"></div>
                            <!-- 右侧的纵向柱形图 -->
                            <div id="category-bar-chart" style="width: 100%; height: 800px;margin-top: 0px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="recordTableContainer" style="display: none">
                <table class="layui-hide" id="recordTable" lay-filter="recordTableFilter"></table>
            </div>
        </div>

        <div>
            <select id="depository-selector-three">
                <option value="">选择厂区</option>
                <option value="1">SAB</option>
                <option value="2">ZAB</option>
            </select>
            <input type="text" id="year-selector-three" placeholder="请选择年" autocomplete="off">
            <button class="layui-input custom-input" id="ID-dropdown-demo-complex-1" >请选择分类</button>
            <input type="hidden" name="applyRemark" id="applyRemarkInput-1" value="">
            <div class="layui-row">
                <!-- 产量柱形图 -->
                <div class="layui-col-md12">
                    <div class="layui-card">
                        <div class="layui-card-header"><i class="fa fa-signal icon"></i>分类柱形图</div>
                        <div class="layui-card-body">
                            <div id="cateAmountChart" style="width: 100%; height: 500px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <select id="depository-selector-two">
                <option value="">选择厂区</option>
                <option value="1">SAB</option>
                <option value="2">ZAB</option>
            </select>
            <input type="text" id="year-selector" placeholder="请选择年" autocomplete="off">
            <select name="typeId" id="typeSelect">
                <option value="">请选择分类</option>
                <option th:each="type : ${materialTypes}" th:value="${type.id}" th:text="${type.id}+' '+${type.tname}"></option>
            </select>
            <div class="layui-row">
                <!-- 产量柱形图 -->
                <div class="layui-col-md12">
                    <div class="layui-card">
                        <div class="layui-card-header"><i class="fa fa-signal icon"></i>产量柱形图</div>
                        <div class="layui-card-body">
                            <div id="typeAmountChart" style="width: 100%; height: 500px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
<script src="/static/lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
<script src="/static/js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<script type="text/javascript" src="/static/js/http_ajax.googleapis.com_ajax_libs_jquery_3.5.1_jquery.js" charset="utf-8"></script>
<script type="text/javascript" src="/static/js/http_cdn.bootcdn.net_ajax_libs_echarts_5.2.0_echarts.js" charset="utf-8"></script>
<script>
    let dropDataSAB = [];
    let dropDataZAB = [];
    layui.use(['layer', 'miniTab','echarts','laydate','table'], function () {
        var $ = layui.jquery,
            layer = layui.layer,
            miniTab = layui.miniTab,
            echarts = layui.echarts,
            laydate = layui.laydate,
            table = layui.table;
        var dropdown = layui.dropdown;
        var userReviewGroupId;
        var userAuthority;
        var userDepositoryId;
        // 用户区分
        $.ajax({
            url: '/get_user_depository',
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                let pp;
                userDepositoryId = data.depositoryId;
                var toolbarTemplate;
                var globalToolbarTemplate;
                userAuthority = data.authority;
                userReviewGroupId = data.review_group_id;
                if (userDepositoryId === 0) {
                    pp = '/notices';
                } else {
                    pp = '/notices?depositoryId=' + userDepositoryId;
                }
                table.render({
                    elem: '#noticeTable',
                    url: pp, // 数据接口
                    height: "full-50",
                    height: 200,
                    parseData: function (res) { // res 即为原始返回的数据
                        return {
                            "status": res.status, // 解析接口状态
                            "message": res.statusInfo.message, // 解析提示文本
                            "count": res.count, // 解析数据长度
                            "data": res.data // 解析数据列表
                        };
                    },
                    response: {
                        statusName: 'status', // 规定数据状态的字段名称，默认：code
                        statusCode: 200, // 规定成功的状态码，默认：0
                        msgName: 'message', // 规定状态信息的字段名称，默认：msg
                        countName: 'count', // 规定数据总数的字段名称，默认：count
                        dataName: 'data' // 规定数据列表的字段名称，默认：data
                    },
                    cols: [ [ // 表头
                        {field: 'title', title: '标题', hide: true},
                        {field: 'atId', title: 'AT号', width:'10%'},
                        {field: 'mname', title: '品名', width:'30%'},
                        {field: 'model', title: '型号', width:'20%'},
                        {field: 'lastCount', title: '最后领用数', width:'12%'},
                        {field: 'time', title: '最后领用时间', width:'18%', sort: true, templet: function(d){
                                return formatDate(d.time);
                            }},
                    ]],
                    done: function(res, curr, count){
                        $('#noticeTable + div .layui-table-body tbody > tr').each(function(){
                            var dataIndex = $(this).attr('data-index');
                            var row = res.data[dataIndex];
                            $(this).css('background-color', 'yellow');
                        });
                    }
                });

                function formatDate(dateStr) {
                    if (!dateStr) return '';
                    let date = new Date(dateStr);
                    let year = date.getFullYear();
                    let month = (date.getMonth() + 1).toString().padStart(2, '0');
                    let day = date.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            },
            error: function() {
                layer.msg('无法获取用户的厂区信息');
            }
        });

        function formatData(apiData) {
            let formattedData = apiData.map(item => {
                let formattedItem = { title: item.title };
                if (item.children && item.children.length > 0) {
                    formattedItem.child = formatData(item.children); // 递归处理子项目
                }
                return formattedItem;
            });
            return formattedData;
        }

        function loadCategoryData(category, callback) {
            $.get('/api/categories/' + category, function(response) {
                if (response.code === 0) {
                    callback(formatData(response.data));
                } else {
                    layer.msg(`无法加载${category.toUpperCase()}的分类数据`);
                }
            }).fail(function() {
                layer.msg(`无法加载${category.toUpperCase()}的分类数据`);
            });
        }

        function loadDepositoryDataForElem(elemSelector, dropdownData) {
            setParentForChild(dropdownData);
            dropdown.render({
                elem: elemSelector,
                data: dropdownData,
                click: function (item) {
                    let path = item.title;
                    let currentItem = item;
                    while (currentItem.parent) {
                        path = currentItem.parent.title + "-" + path;
                        currentItem = currentItem.parent;
                    }
                    let displayTitle = path.split('-').pop();
                    $(elemSelector).text(displayTitle);
                    const remarkInputSelector = elemSelector.replace(/ID-dropdown-demo-complex(-\d+)?$/, "applyRemarkInput$1");
                    $(remarkInputSelector).val(displayTitle);
                    fetchCateChart();
                }
            });
        }

        function setParentForChild(data) {
            for (let i = 0; i < data.length; i++) {
                if (data[i].child) {
                    for (let j = 0; j < data[i].child.length; j++) {
                        data[i].child[j].parent = data[i];
                    }
                    setParentForChild(data[i].child);
                }
            }
        }

        // 初始化日期选择器
        laydate.render({
            elem: '#month-selector',
            type: 'month',
            done: function(value, date, endDate) {
                if (document.getElementById('depository-selector').value) {
                    fetchDataForMonth(value);
                } else {
                    alert("请先选择一个厂区！");
                }
            }
        });

        laydate.render({ elem: '#year-selector', type: 'year' });
        laydate.render({ elem: '#year-selector-three', type: 'year', done: fetchCateChart });

        var myChartCate = echarts.init(document.getElementById('cateAmountChart'));

        function fetchCateChart() {
            var year = document.getElementById('year-selector-three').value;
            var depositoryId = document.getElementById('depository-selector-three').value;
            var categoryTitle = document.getElementById('applyRemarkInput-1').value;

            if (!depositoryId ) {
                alert("请确保已选择所有条件！");
                return;
            }
            var url = '/CategoryForYear/' + year + '/' + depositoryId + '/' + categoryTitle;
            $.get(url, function(data) {
                var colors = ['#5470C6'];
                var option = {
                    title: { text: '分类柱形图' },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'shadow' }
                    },
                    xAxis: { data: data.map(function(item) { return item.month; }) },
                    yAxis: [ { type: 'value', position: 'left' } ],
                    series: [
                        {
                            name: '金额',
                            type: 'bar',
                            yAxisIndex: 0,
                            data: data.map(function(item) { return item.amount; }),
                            label: { normal: { show: true, position: 'top' } },
                            itemStyle: { normal: { color: function(params) { return colors[params.dataIndex % colors.length]; } } }
                        }
                    ]
                };
                myChartCate.clear(); // 清除旧的图表数据
                myChartCate.setOption(option, true); // 使用新数据更新图表，第二个参数为 true 表示不合并
            });
        }

        function handleDepositoryChange() {
            var depositoryId = document.getElementById('depository-selector-three').value;
            var catedepositoryId = (depositoryId == 1) ? "sab" : "zab";
            // // 清空之前的分类选择器内容 有BUG
            // document.getElementById('ID-dropdown-demo-complex-1').innerText = '选择分类';
            // document.getElementById('applyRemarkInput-1').value = '';
            loadCategoryData(catedepositoryId, function(data) {
                if (depositoryId == 1) {
                    dropDataSAB = data;
                    loadDepositoryDataForElem('#ID-dropdown-demo-complex-1', dropDataSAB);
                } else {
                    dropDataZAB = data;
                    loadDepositoryDataForElem('#ID-dropdown-demo-complex-1', dropDataZAB);
                }
                // 重新加载数据后调用fetchCateChart以确保图表更新
                fetchCateChart();
            });
        }
        document.getElementById('depository-selector-three').addEventListener('change', handleDepositoryChange);
        // 初始化ECharts实例
        var myChart = echarts.init(document.getElementById('typeAmountChart')); // 请确保您的div有一个ID，例如typeAmountChart

        function fetchTypeAmountDataAndRenderChart() {
            var year = document.getElementById('year-selector').value;
            var depositoryId = document.getElementById('depository-selector-two').value;
            var typeId = document.getElementById('typeSelect').value;

            var url = '/type-amounts/' + year + '/' + typeId + '/' + depositoryId;
            // var url = '/CategoryForYear/' + year + '/' + depositoryId + '/' +"N沟" ;
            $.get(url, function(data) {
                var colors = ['#5470C6'];
                var option = {
                    title: { text: '产量柱形图' },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'shadow' }
                    },
                    xAxis: { data: data.map(function(item) { return item.month; }) },
                    yAxis: [
                        { type: 'value', position: 'left' },
                        { type: 'value', position: 'right', show: true, splitLine: { show: false } }
                    ],
                    series: [
                        {
                            name: '金额',
                            type: 'bar',
                            yAxisIndex: 0,
                            data: data.map(function(item) { return item.monthlyAmount; }),
                            label: { normal: { show: true, position: 'top' } },
                            itemStyle: { normal: { color: function(params) { return colors[params.dataIndex % colors.length]; } } }
                        },
                        {
                            name: '单价',
                            type: 'line',
                            yAxisIndex: 1,
                            data: data.map(function(item) { return item.unitPrice; }),
                            smooth: true,
                            label: { normal: { show: true, position: 'top' } },
                        }
                    ]
                };
                myChart.clear(); // 清除旧的图表数据
                myChart.setOption(option, true); // 使用新数据更新图表，第二个参数为 true 表示不合并
            });
        }
        document.getElementById('depository-selector-two').addEventListener('change', fetchTypeAmountDataAndRenderChart);
        document.getElementById('year-selector').addEventListener('change', fetchTypeAmountDataAndRenderChart);
        document.getElementById('typeSelect').addEventListener('change', fetchTypeAmountDataAndRenderChart);

        // 为厂区选择器添加事件监听器
        document.getElementById('depository-selector').addEventListener('change', function() {
            var selectedMonth = document.getElementById('month-selector').value;
            if (selectedMonth) {
                fetchDataForMonth(selectedMonth);
            }
        });
        var legendData = ['金额', '单个成本'];
        var chart1;
        var chart2;
        function fetchDataForMonth(yearMonth) {
            var parts = yearMonth.split('-');  // 拆分为 ["2023", "01"]
            var year = parts[0];
            var month = parts[1];
            var selectedDepositoryId = document.getElementById('depository-selector').value;
            if (selectedDepositoryId) {
                $.ajax({
                    url: '/category-outbounds/' + year + '/' + month + '/' + selectedDepositoryId,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        // 获取 lineData 数据
                        $.ajax({
                            url: '/lineData/' + year + '/' + month,
                            type: 'GET',
                            dataType: 'json',
                            success: function(response) {
                                var lineData = response.data;
                                console.log("Fetched lineData:", lineData);  // 添加调试日志
                                if (!Array.isArray(lineData)) {
                                    console.error("lineData is not an array: 不是数组", lineData);
                                    return;
                                }
                                initCategoryBarChart(data, lineData);
                                initOtherCategoryBarChart(data, lineData);
                                // 在图表初始化完成后调用 syncLegend 同步图例
                                if (chart1 && chart2) {
                                    console.log("Charts initialized successfully:", chart1, chart2);
                                    syncLegend(chart1, chart2);
                                } else {
                                    console.error("Chart initialization failed. chart1:", chart1, "chart2:", chart2);
                                }
                            },
                            error: function(error) {
                                console.log("Error fetching line data：获取行数据时出错", error);
                            }
                        });

                    },
                    error: function(error) {
                        console.log("Error fetching category outbounds：提取类别出站时出错", error);
                    }
                });
            } else {
                alert("请先选择一个厂区！");
                // layer.msg('请先选择一个厂区！');
            }
        }
        miniTab.listen();

        /**
         * 查看公告信息
         **/
        $('body').on('click', '.layuimini-notice', function () {
            var title = $(this).children('.layuimini-notice-title').text(),
                noticeTime = $(this).children('.layuimini-notice-extra').text(),
                content = $(this).children('.layuimini-notice-content').html();
            var html = '<div style="padding:15px 20px; text-align:justify; line-height: 22px;border-bottom:1px solid #e2e2e2;background-color: #2f4056;color: #ffffff">\n' +
                '<div style="text-align: center;margin-bottom: 20px;font-weight: bold;border-bottom:1px solid #718fb5;padding-bottom: 5px"><h4 class="text-danger">' + title + '</h4></div>\n' +
                '<div style="font-size: 12px">' + content + '</div>\n' +
                '</div>\n';
            parent.layer.open({
                type: 1,
                title: '系统公告'+'<span style="float: right;right: 1px;font-size: 12px;color: #b1b3b9;margin-top: 1px">'+noticeTime+'</span>',
                area: '300px;',
                shade: 0.8,
                id: 'layuimini-notice',
                btn: ['取消'],
                btnAlign: 'c',
                moveType: 1,
                content:html,
            });
        });

        /**
         * 图功能
         */
        laydate.render({
            elem: '#year-selector0',
            type: 'year',
            done: function(value, date, endDate){
                // 当选择年份后，调用 fetchData 函数
                fetchData(value);
            }
        });

        $(document).ready(function () {
            // 页面加载时获取当前年份并调用 fetchData 函数
            var year = new Date().getFullYear();
            fetchData(year);
        });

        function fetchData(year) {
            $.ajax({
                url: '/monthly-amounts/' + year,
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    // 当成功获取数据时，初始化并设置 ECharts 图表
                    initECharts(data);
                },
                error: function (error) {
                    console.log("Error fetching data", error);
                }
            });
        }

        var echartsInstances = [];
        function initECharts(data) {
            var months = data.map(item => {
                var dateParts = item.month.split("-");
                return dateParts[1] + '月';  // 返回“月份 + '月'”格式
            });

            // 入库金额图
            var sabInbound = data.map(item => item.sabInboundAmount);
            var zabInbound = data.map(item => item.zabInboundAmount);

            // 出库金额图
            var sabOutbound = data.map(item => item.sabOutboundAmount);
            var zabOutbound = data.map(item => item.zabOutboundAmount);

            // 在库金额图
            var sabStock = data.map(item => item.sabStockAmount);
            var zabStock = data.map(item => item.zabStockAmount);

            echartsInstances.push(initChart('inbound-chart', months, sabInbound, zabInbound, '入库金额'));
            echartsInstances.push(initChart('outbound-chart', months, sabOutbound, zabOutbound, '出库金额'));
            echartsInstances.push(initBarChart('stock-chart', months, sabStock, zabStock, '库存流水'));
        }

        function initCategoryBarChart(data, lineData) {
            var categories = data
                .map(item => item.category)// 获取所有的类别
                    .filter(category => category.includes("线") || category.endsWith("机"));//获取所有带有“线”或以“机”结尾的类别
                // .filter(category => !category.includes("线") && !category.endsWith("机"));

            console.log(categories);
            // 使用Set去除重复的类别
            var uniqueCategories = [...new Set(categories)];
            // 获取每个类别的总金额
            var amounts = uniqueCategories.map(category => {
                var categoryData = data.find(item => item.category === category);
                return categoryData ? categoryData.amount : 0;
            });
            // 获取每个类别的产量
            var productions = uniqueCategories.map(category => {
                var lineDataItem = lineData.find(item => item.lineName === category);
                return lineDataItem ? lineDataItem.production : 0;
            });
            var totalProduction = productions.reduce((acc, curr) => acc + curr, 0);
            var totalPrice = amounts.reduce((acc, curr) => acc + curr, 0)
            var referenceLineValue = (totalPrice / totalProduction).toFixed(3);
            console.log(totalPrice);
            console.log(totalProduction);
            console.log(referenceLineValue);

            // 计算每个类别的单价，并保留两位小数
            var unitPrices = amounts.map((amount, index) => {
                return productions[index] > 0 ? parseFloat((amount / productions[index]).toFixed(3)) : 0;
            });
            var colors = ['#5470C6', '#91CC75', '#EE6666', '#E87C25', '#FFD85C', '#73C0DE', '#3BA272', '#FC8452', '#9A60B4', '#EA7CCC'];

            var option2 = {
                title: {
                    text: '单能线',  // 设置标题文本
                    left: 'center',  // 标题居中
                    top: 'top',  // 标题在图表的顶部
                    textStyle: {
                        fontSize: 16,  // 标题字体大小
                        fontWeight: 'bold',  // 标题字体加粗
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                grid: {
                    left: '3%',   // 图表左边距
                    right: '3%',  // 图表右边距
                    top: '200px',    // 图表上边距
                    // bottom: '15%'  // 图表下边距
                },
                legend: {
                    data: legendData,
                    left: 'right',
                    // top: '200px',
                    selected: { '金额': true, '单个成本': true }
                },
                xAxis: {
                    type: 'category',
                    data: uniqueCategories,
                    axisLabel: {
                        interval: 0,
                        rotate: 90,
                    }
                },
                yAxis: [
                    { type: 'value', name: '金额',axisLabel: {
                            formatter: '{value}',
                            rotate: 90  // 旋转x轴第二轴标签90度，使其  竖着显示
                        },
                    },
                    {
                        type: 'value',
                        name: '单个成本',
                        axisTick: { show: false },  // 隐藏y轴的刻度线
                        splitLine: { show: false }, // 隐藏y轴的网格线
                        axisLabel: {
                            formatter: function(value) {
                                return value.toFixed(3); // 保留三位小数
                            },
                            rotate: 90  // 旋转x轴第二轴标签90度，使其竖着显示
                        },
                    },
                    {
                        type: 'value',
                        name: '',
                        position: 'right',
                        axisLabel: {
                            show:false
                        }
                    }
                ],
                series: [
                    {
                        name: '金额',
                        type: 'bar',
                        data: amounts.map((amount, index) => ({
                            value: amount,
                            label: {
                                distance: index % 2 === 0 ? 15 : 2  // Manually setting distance alternation
                            }
                        })),
                        barWidth: '60%',  // 调整条形图宽度
                        barCategoryGap: '30%',  // 调整类别间距
                        label: {
                            normal: {
                                show: true,
                                position: 'top',
                                formatter: function(params) {
                                    return params.value;
                                }
                            }
                        },
                        itemStyle: {
                            normal: {
                                color: function(params) {
                                    return colors[params.dataIndex % colors.length];
                                }
                            }
                        }
                    },
                    {
                        name: '单个成本',
                        type: 'line',
                        yAxisIndex: 1,  // 使用第二个Y轴
                        data: unitPrices,
                        label: {
                            normal: {
                                show: true,
                                position: 'top',
                                textStyle: {
                                    color: '#000000'  // 将数字标注颜色设置为黑色
                                },
                            }
                        },
                        lineStyle: {
                            normal: {
                                color: '#bf2222',  // 折线颜色

                                opacity: 0.5  // 设置透明度，将折线虚化
                            }
                        },
                        itemStyle: {
                            normal: {
                                opacity: 0.5  // 设置透明度，将折线虚化
                            }
                        },
                        markLine: {
                            data: [
                                {
                                    name: '平均',
                                    yAxis: referenceLineValue,  // 在x轴上显示平均值
                                    label: {
                                        // show:false,
                                        formatter: '{c}',
                                        position: 'middle'
                                    },
                                    lineStyle: {
                                        type: 'solid', //dotted
                                        color: '#bf2222'  // 线的颜色
                                    }
                                }
                            ]
                        }
                    },
                    {
                        name: '产量',
                        type: 'bar',
                        yAxisIndex: 2,  // 使用第三个Y轴
                        data: productions,
                        barWidth: '0%',  // 将条形图宽度设置为0%
                        label: {
                            show: false  // 隐藏标签
                        },
                        itemStyle: {
                            opacity: 0  // 将条形图样式的透明度设置为0
                        }
                    }

                ]
            };
            chart2 = echarts.init(document.getElementById('category-bar-chart'));
            chart2.clear();
            chart2.off('click');
            chart2.setOption(option2);
            chart2.on('click', function (params) {
                var selectedDepositoryId = document.getElementById('depository-selector').value;
                var selectedMonth = document.getElementById('month-selector').value;
                var parts = selectedMonth.split('-');
                var year = parts[0];
                var month = parts[1];
                var encodedCategoryName = encodeURIComponent(params.name);
                $.ajax({
                    url: '/api/categories/category-records/' + encodedCategoryName + '/' + selectedDepositoryId + '/' + year + '/' + month,
                    type: 'GET',
                    dataType: 'json',
                    success: function(records) {
                        var widthPercentage = 80;
                        var heightPercentage = 80;

                        var screenWidth = $(window).width();
                        var screenHeight = $(window).height();

                        var popupWidth = (widthPercentage / 100) * screenWidth;
                        var popupHeight = (heightPercentage / 100) * screenHeight;

                        var maxPopupWidth = 2800;
                        var maxPopupHeight = 2600;

                        popupWidth = Math.min(popupWidth, maxPopupWidth);
                        popupHeight = Math.min(popupHeight, maxPopupHeight);

                        layer.open({
                            type: 1,
                            title: params.name,
                            content: $('#recordTableContainer'),
                            area: [popupWidth + 'px', popupHeight + 'px'],
                            shadeClose: true
                        });

                        renderTable(records);
                    },
                    error: function(error) {
                        console.log("Error fetching records for category", error);
                    }
                });
            });
            function renderTable(records) {
                function formatDate(dateStr) {
                    if (!dateStr) return '';
                    let date = new Date(dateStr);
                    let year = date.getFullYear();
                    let month = (date.getMonth() + 1).toString().padStart(2, '0');
                    let day = date.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }

                table.render({
                    elem: '#recordTable',
                    height: "full-50",
                    cols: [ [
                        { field: 'sourceTable', title: '来源表',  hide: true},
                        { field: 'id', title: 'ID', hide: true},
                        {
                            field: 'atId',
                            title: 'AT',
                            templet: function(d) {
                                return d.atId ? d.atId : '一次性';
                            }
                        },
                        { field: 'name', title: '名称' },
                        { field: 'model', title: '型号'},
                        { field: 'quantity', title: '数量'},
                        { field: 'unitPrice', title: '单价' },
                        { field: 'totalAmount', title: '金额', templet: function(d) {
                                return parseFloat(d.totalAmount).toFixed(2);
                            }},
                        {
                            field: 'recordDate',
                            title: '记录日期',
                            hide: true,
                            flex:1,
                            templet: function(d) {
                                return formatDate(d.recordDate);
                            }
                        },
                        { field: 'applyRemark', title: '备注' ,hide: true},
                        { field: 'categoryTitle', title: '分类标题' ,hide: true}
                    ]],
                    limit: records.length,
                    data: records,
                });
            }
        }
        function initOtherCategoryBarChart(data, lineData) {
            var otherCategories = data
                .map(item => item.category)
                .filter(category => !category.includes("线") && !category.endsWith("机"));

            var categories = data
                .map(item => item.category)
                .filter(category => category.includes("线") || category.endsWith("机"));

            console.log(otherCategories);

            var uniqueOtherCategories = [...new Set(otherCategories)].reverse();
            var uniqueCategories = [...new Set(categories)];

            var otherAmounts = uniqueOtherCategories.map(category => {
                var categoryData = data.find(item => item.category === category);
                return categoryData ? categoryData.amount : 0;
            });

            var productions = uniqueCategories.map(category => {
                var lineDataItem = lineData.find(item => item.lineName === category);
                return lineDataItem ? lineDataItem.production : 0;
            });

            // 计算总产量
            var totalProduction = productions.reduce((acc, curr) => acc + curr, 0);

            // 计算单个成本
            var otherUnitPrices = otherAmounts.map((amount) => {
                return totalProduction > 0 ? parseFloat((amount / totalProduction).toFixed(3)) : 0;
            });
            var totalUnitCost = otherUnitPrices.reduce((acc, curr) => acc + curr, 0).toFixed(3);

            var referenceLineValue = (otherAmounts.reduce((acc, curr) => acc + curr, 0) / totalProduction / 17).toFixed(3);

            var colors = ['#5470C6', '#91CC75', '#EE6666', '#E87C25', '#FFD85C', '#73C0DE', '#3BA272', '#FC8452', '#9A60B4', '#EA7CCC'];

            var option1 = {
                title: {
                    text: `共通工程（单个成本：${totalUnitCost}）`,  // 动态设置标题文本
                    left: 'center',  // 标题居中
                    top: 'top',  // 标题在图表的顶部
                    textStyle: {
                        fontSize: 16,  // 标题字体大小
                        fontWeight: 'bold',  // 标题字体加粗
                    }
                },
                legend: {
                    data: legendData,
                    left: 'left',
                    selected: { '金额': true, '单个成本': true },
                    show: false  // 隐藏图例
                },
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                grid: {
                    left: '20%',   // 图表左边距
                    right: '10%',  // 图表右边距
                    // top: '15%',    // 图表上边距
                    // bottom: '15%'  // 图表下边距
                },
                yAxis: {
                    type: 'category',
                    data: uniqueOtherCategories,
                    axisLabel: {
                        interval: 0,
                        rotate: 0,
                        margin: 0,
                        align: 'right',
                        inside: false
                    },
                    position: 'left',
                    z: 10,  // 确保y轴标签在最顶层
                },
                xAxis: [
                    {
                        type: 'value',
                        name: '金额',
                        position: 'top',  // 位置在顶部
                        axisLabel: {
                            formatter: '{value}'  // 显示单位
                        }
                    },
                    {
                        type: 'value',
                        name: '',
                        position: 'bottom',  // 位置在底部
                        axisLabel: {
                            formatter: '{value}'  // 保留两位小数
                        },
                        axisTick: { show: false },  // 隐藏y轴的刻度线
                        splitLine: { show: false }  // 隐藏y轴的网格线
                    }
                ],
                series: [
                    {
                        name: '金额',
                        type: 'bar',
                        data: otherAmounts,
                        label: {
                            normal: {
                                show: true,
                                position: 'right',
                                formatter: function(params) {
                                    return params.value;  // 显示实际金额
                                }
                            }
                        },
                        itemStyle: {
                            normal: {
                                color: function(params) {
                                    return colors[params.dataIndex % colors.length];
                                }
                            }
                        }
                    },
                    {
                        name: '单个成本',
                        type: 'line',
                        xAxisIndex: 1,  // 使用第二个x轴
                        data: otherUnitPrices,
                        label: {
                            normal: {
                                show: true,
                                position: 'top',
                                formatter: function(params) {
                                    return params.value;  // 显示实际单个成本
                                },
                                textStyle: {
                                    color: '#000000'  // 将数字标注颜色设置为黑色
                                }
                            }
                        },
                        lineStyle: {
                            normal: {
                                color: '#bf2222',  // 折线颜色
                                opacity: 0.5  // 设置透明度，将折线虚化
                            }
                        },
                        itemStyle: {
                            normal: {
                                opacity: 0.5  // 设置点的透明度为0，使得点不被显示
                            }
                        },

                    }
                ]
            };

            chart1 = echarts.init(document.getElementById('other-category-bar-chart'));
            chart1.clear();
            chart1.off('click');
            chart1.setOption(option1);
            chart1.on('click', function (params) {
                var selectedDepositoryId = document.getElementById('depository-selector').value;
                var selectedMonth = document.getElementById('month-selector').value;
                var parts = selectedMonth.split('-');
                var year = parts[0];
                var month = parts[1];
                var encodedCategoryName = encodeURIComponent(params.name);
                $.ajax({
                    url: '/api/categories/category-records/' + encodedCategoryName + '/' + selectedDepositoryId + '/' + year + '/' + month,
                    type: 'GET',
                    dataType: 'json',
                    success: function(records) {
                        var widthPercentage = 80;
                        var heightPercentage = 80;

                        var screenWidth = $(window).width();
                        var screenHeight = $(window).height();

                        var popupWidth = (widthPercentage / 100) * screenWidth;
                        var popupHeight = (heightPercentage / 100) * screenHeight;

                        var maxPopupWidth = 2800;
                        var maxPopupHeight = 2600;

                        popupWidth = Math.min(popupWidth, maxPopupWidth);
                        popupHeight = Math.min(popupHeight, maxPopupHeight);

                        layer.open({
                            type: 1,
                            title: params.name,
                            content: $('#recordTableContainer'),
                            area: [popupWidth + 'px', popupHeight + 'px'],
                            shadeClose: true
                        });

                        renderTable(records);
                    },
                    error: function(error) {
                        console.log("Error fetching records for category", error);
                    }
                });
            });
            function renderTable(records) {
                function formatDate(dateStr) {
                    if (!dateStr) return '';
                    let date = new Date(dateStr);
                    let year = date.getFullYear();
                    let month = (date.getMonth() + 1).toString().padStart(2, '0');
                    let day = date.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }

                table.render({
                    elem: '#recordTable',
                    height: "full-50",
                    cols: [ [
                        { field: 'sourceTable', title: '来源表',  hide: true},
                        { field: 'id', title: 'ID', hide: true},
                        {
                            field: 'atId',
                            title: 'AT',
                            templet: function(d) {
                                return d.atId ? d.atId : '一次性';
                            }
                        },
                        { field: 'name', title: '名称' },
                        { field: 'model', title: '型号'},
                        { field: 'quantity', title: '数量'},
                        { field: 'unitPrice', title: '单价' },
                        { field: 'totalAmount', title: '金额', templet: function(d) {
                                return parseFloat(d.totalAmount).toFixed(2);
                            }},
                        {
                            field: 'recordDate',
                            title: '记录日期',
                            hide: true,
                            flex:1,
                            templet: function(d) {
                                return formatDate(d.recordDate);
                            }
                        },
                        { field: 'applyRemark', title: '备注' ,hide: true},
                        { field: 'categoryTitle', title: '分类标题' ,hide: true}
                    ]],
                    limit: records.length,
                    data: records,
                });
            }
        }
        function syncLegend(chart1, chart2) {
            chart1.on('legendselectchanged', function(event) {
                chart2.dispatchAction({
                    type: event.selected[event.name] ? 'legendSelect' : 'legendUnSelect',
                    name: event.name
                });
            });

            chart2.on('legendselectchanged', function(event) {
                chart1.dispatchAction({
                    type: event.selected[event.name] ? 'legendSelect' : 'legendUnSelect',
                    name: event.name
                });
            });
        }

        function initChart(chartId, months, sabData, zabData, title) {
            var echartsInstance = echarts.init(document.getElementById(chartId), 'walden');
            var option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: "cross",
                        label: { backgroundColor: "#6e7985" }
                    }
                },
                legend: { data: ['SAB', 'ZAB'] },
                title: { text: title, left: 'left' },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                toolbox: { feature: { saveAsImage: {} } },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: months
                },
                yAxis: { type: 'value' },
                series: [
                    {
                        name: 'SAB',
                        type: 'line',
                        smooth: false,
                        label: { normal: { show: true, position: 'left' } },
                        areaStyle: {},
                        data: sabData
                    },
                    {
                        name: 'ZAB',
                        type: 'line',
                        smooth: false,
                        label: { normal: { show: true, position: 'right' } },
                        areaStyle: {},
                        data: zabData
                    }
                ]
            };
            echartsInstance.setOption(option);
            return echartsInstance;
        }

        function initBarChart(chartId, months, sabData, zabData, title) {
            var echartsInstance = echarts.init(document.getElementById(chartId), 'walden');
            var option = {
                tooltip: { trigger: 'axis' },
                legend: { data: ['SAB', 'ZAB'] },
                title: { text: title, left: 'left' },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                toolbox: { feature: { saveAsImage: {} } },
                xAxis: { type: 'category', data: months },
                yAxis: { type: 'value' },
                series: [
                    {
                        name: 'SAB',
                        type: 'bar',
                        barGap: '1%',
                        label: { normal: { show: true, position: 'top' } },
                        data: sabData
                    },
                    {
                        name: 'ZAB',
                        type: 'bar',
                        barGap: '1%',
                        label: { normal: { show: true, position: 'top' } },
                        data: zabData,
                    }
                ]
            };
            echartsInstance.setOption(option);
            return echartsInstance;
        }

        window.onresize = function(){
            for (var i = 0; i < echartsInstances.length; i++) {
                echartsInstances[i].resize();
            }
        }
    });

</script>
</body>
</html>